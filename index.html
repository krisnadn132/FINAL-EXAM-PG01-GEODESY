<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Krisna Exam System - FINAL EXAM PG01 (MCQ + ESSAY)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #2d3436;
  --muted: #636e72;
  --teal: #008080;
  --teal-light: #e0f2f2;
  --correct: #27ae60;
  --wrong: #d63031;
  --border: #dfe6e9;
  --admin-color: #6c5ce7;
  --info-bg: #e1f5fe;
  --essay-bg: #fff3e0;
  --warning: #f39c12;
}

* { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
body { margin: 0; background: var(--bg); color: var(--text); line-height: 1.6; }

header { background: var(--card); border-bottom: 3px solid var(--teal); box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 10px 20px; position: sticky; top: 0; z-index: 1000; }
.header-inner { max-width: 1200px; margin: auto; display: flex; justify-content: space-between; align-items: center; }
h1 { margin: 0; color: var(--teal); font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }

.container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
.card { background: var(--card); border-radius: 8px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; }
.card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

/* Badges */
.badge-essay { background: #f39c12; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
.badge-mcq { background: var(--teal); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }

.exam-grid { display: grid; grid-template-columns: 260px 1fr 260px; gap: 20px; align-items: start; }
.sidebar-left, .sidebar-right { position: sticky; top: 80px; background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
.sidebar-left { border-left: 4px solid var(--teal); }
.sidebar-right { border-right: 4px solid var(--teal); }

.timer-box { font-size: 1.8rem; font-weight: bold; text-align: center; margin: 15px 0; padding: 10px; background: var(--bg); border-radius: 5px; border: 1px solid var(--border); font-family: 'Courier New', monospace; }

.nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; padding: 5px; }
.nav-btn { padding: 8px 0; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; }
.nav-btn:hover { background: var(--teal-light); transform: scale(1.05); }
.nav-btn.answered { background: var(--teal); color: white; border-color: var(--teal); }
.nav-btn.current { border: 2px solid var(--warning); box-shadow: 0 0 8px rgba(243, 156, 18, 0.5); }

.option { display: block; border: 1px solid var(--border); padding: 12px 15px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; position: relative; }
.option:hover { border-color: var(--teal); background: #f8fffe; }
.option.selected { border-color: var(--teal); background: var(--teal-light); font-weight: 600; }
.correct-view { background: #d4edda !important; border-color: #c3e6cb !important; color: #155724; }
.wrong-view { background: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; }

.explanation-box { background: var(--info-bg); padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #0288d1; font-size: 0.9rem; }
.model-answer-box { background: #e8f5e9; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #2e7d32; font-size: 0.9rem; }
.user-essay-box { background: var(--essay-bg); padding: 15px; border-radius: 6px; margin-top: 10px; border: 1px dashed #f39c12; font-style: italic; }

button { background: var(--teal); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
button:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
button:active { transform: translateY(0); }
button.secondary { background: var(--muted); }
button.danger { background: var(--wrong); }
button.admin-btn { background: var(--admin-color); width: auto; font-size: 0.8rem; padding: 5px 10px; margin-left: 5px; }

textarea { width: 100%; height: 120px; padding: 12px; border-radius: 6px; border: 1px solid var(--border); font-size: 1rem; resize: vertical; margin-top: 10px; font-family: inherit; }
textarea:focus { outline: none; border-color: var(--teal); box-shadow: 0 0 5px rgba(0,128,128,0.2); }

.char-counter { text-align: right; font-size: 0.75rem; color: var(--muted); margin-top: 5px; }
.char-counter.warning { color: var(--warning); }

input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; transition: border 0.2s; }
input:focus { outline: none; border-color: var(--teal); box-shadow: 0 0 5px rgba(0,128,128,0.2); }

.hidden { display: none !important; }

/* Progress Bar */
.progress-container { width: 100%; background: var(--border); border-radius: 10px; height: 8px; margin: 15px 0; overflow: hidden; }
.progress-bar { height: 100%; background: linear-gradient(90deg, var(--teal), #00a8a8); transition: width 0.3s ease; border-radius: 10px; }

/* Statistics Panel */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
.stat-box { background: var(--bg); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid var(--border); }
.stat-box .stat-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; }
.stat-box .stat-value { font-size: 1.3rem; font-weight: bold; color: var(--teal); }

/* Keyboard Shortcuts Info */
.shortcut-hint { background: #fff9e6; border: 1px solid #ffe58f; border-radius: 5px; padding: 10px; margin-top: 15px; font-size: 0.75rem; }
.shortcut-hint kbd { background: white; border: 1px solid #ccc; border-radius: 3px; padding: 2px 6px; font-family: monospace; }

/* Auto-save Indicator */
.autosave-indicator { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px 20px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.85rem; display: none; align-items: center; gap: 8px; z-index: 1000; }
.autosave-indicator.show { display: flex; animation: slideIn 0.3s ease; }
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

/* Filter and Search */
.filter-bar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
.filter-btn { padding: 8px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; width: auto; }
.filter-btn:hover { background: var(--teal-light); }
.filter-btn.active { background: var(--teal); color: white; }

.search-box { flex: 1; min-width: 200px; }

/* Enhanced Table */
table { border-collapse: collapse; width: 100%; }
tbody tr { transition: background 0.2s; }
tbody tr:hover { background: var(--teal-light); }

/* Loading Spinner */
.spinner { border: 3px solid var(--border); border-top: 3px solid var(--teal); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Tooltip */
.tooltip { position: relative; display: inline-block; }
.tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; }
.tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

/* Print Styles */
@media print {
    header, .sidebar-left, .sidebar-right, button { display: none; }
    .exam-grid { display: block; }
    .card { page-break-inside: avoid; }
}

@media (max-width: 900px) {
    .exam-grid { display: block; }
    .sidebar-left, .sidebar-right { position: relative; top: 0; width: 100%; margin-bottom: 20px; }
    .stats-grid { grid-template-columns: 1fr; }
    h1 { font-size: 1rem; }
}

/* Dark Mode Toggle */
body.dark-mode {
    --bg: #1a1a1a;
    --card: #2d2d2d;
    --text: #e0e0e0;
    --border: #444;
    --bg-alt: #242424;
}

.theme-toggle { background: none; width: auto; padding: 8px; font-size: 1.2rem; margin-left: 10px; }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex; align-items:center; gap:10px;">
        <i class="fas fa-globe-asia" style="color:var(--teal); font-size:1.5rem;"></i>
        <h1>Krisna Exam System <small style="font-size:0.6rem; opacity:0.7;">PG01 COMPREHENSIVE</small></h1>
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
        <div id="userDisplay" style="font-weight:bold; color:var(--muted);"></div>
        <button class="theme-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </button>
    </div>
  </div>
</header>

<div class="container">
  <div id="startScreen" class="card" style="max-width:400px; margin: 60px auto; text-align:center;">
    <h2 style="color:var(--teal)">Secure Access</h2>
    <p style="font-size:0.8rem; color:var(--muted);">PG01 GEODESY FINAL</p>
    <input type="text" id="candidateName" placeholder="Username" autocomplete="username">
    <input type="password" id="candidatePass" placeholder="Password" autocomplete="current-password" onkeypress="if(event.key==='Enter') login()">
    <button onclick="login()">ENTER SYSTEM <i class="fas fa-sign-in-alt"></i></button>
    <div style="margin-top: 20px; padding: 15px; background: var(--info-bg); border-radius: 5px; font-size: 0.8rem; text-align: left;">
        <strong><i class="fas fa-info-circle"></i> Test Credentials:</strong><br>
        Student: ***** / *****<br>
        Admin: ***** / *****
    </div>
  </div>

  <div id="menuScreen" class="hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">EXAMINATION DASHBOARD</h3>
            <button class="secondary" style="width:auto;" onclick="logout()">Logout <i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div id="roleBadge" style="display:inline-block; padding:5px 15px; border-radius:20px; font-size:0.8rem; font-weight:bold; margin-bottom:20px;"></div>
        
        <button id="mainModuleBtn" onclick="handleModuleClick()" style="background:#e0f2f2; color:var(--teal); border:2px solid var(--teal); padding:30px; font-size:1.1rem; text-align:left;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <i class="fas fa-graduation-cap"></i> Start Final Exam (50 MCQ + 25 Essay)
                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">Duration: No time limit | Total: 75 questions</div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
        </button>

        <div style="margin-top: 20px;">
            <h4>Your Performance Summary</h4>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Attempts</div>
                    <div class="stat-value" id="userAttempts">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Best Score</div>
                    <div class="stat-value" id="userBestScore">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Average</div>
                    <div class="stat-value" id="userAvgScore">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Last Attempt</div>
                    <div class="stat-value" id="userLastDate" style="font-size: 0.8rem;">-</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Performance History</h3>
            <div id="adminTools" class="hidden">
                <button class="admin-btn" onclick="exportCSV()"><i class="fas fa-download"></i> CSV</button>
                <button class="admin-btn" onclick="exportJSON()"><i class="fas fa-file-code"></i> JSON</button>
                <button class="admin-btn danger" onclick="clearAllData()"><i class="fas fa-trash-alt"></i> Clear All</button>
            </div>
        </div>

        <div class="filter-bar">
            <input type="text" id="searchHistory" class="search-box" placeholder="ðŸ” Search by name..." oninput="filterHistory()">
            <button class="filter-btn active" onclick="sortHistory('date')">Sort by Date</button>
            <button class="filter-btn" onclick="sortHistory('score')">Sort by Score</button>
            <button class="filter-btn" onclick="sortHistory('name')">Sort by Name</button>
        </div>

        <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                <thead><tr style="background:#f8f9fa;">
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Candidate</th>
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Score</th>
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Date</th>
                    <th id="adminCol" class="hidden" style="padding:10px; border-bottom:1px solid #ddd; text-align:center;">Action</th>
                </tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="examScreen" class="exam-grid hidden">
    <aside class="sidebar-left">
        <h3>Details</h3>
        <p id="displayUser" style="font-size:0.8rem; color:var(--muted);"></p>
        <div class="timer-box" id="timerDisplay">00:00</div>
        
        <div style="margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--muted); margin-bottom: 5px;">
                <span>Progress</span>
                <span id="progressText">0/75</span>
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">MCQ</div>
                <div class="stat-value" id="mcqCount">0/50</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Essay</div>
                <div class="stat-value" id="essayCount">0/25</div>
            </div>
        </div>

        <div class="shortcut-hint">
            <strong>ðŸ’¡ Shortcuts:</strong><br>
            <kbd>Ctrl</kbd>+<kbd>S</kbd> Save Draft<br>
            <kbd>Ctrl</kbd>+<kbd>Enter</kbd> Submit
        </div>

        <button onclick="saveDraft()" class="secondary" style="margin-top: 10px;">
            <i class="fas fa-save"></i> Save Draft
        </button>
        <button onclick="exitExam()" class="secondary" style="margin-top: 10px;">
            <i class="fas fa-times"></i> Cancel
        </button>
    </aside>

    <section id="qBox"></section>

    <aside class="sidebar-right">
        <h4>Navigation</h4>
        <div style="font-size: 0.7rem; color: var(--muted); margin-bottom: 10px;">
            <span style="background: var(--teal); color: white; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">â– </span> Answered
            <span style="background: var(--bg); padding: 2px 6px; border-radius: 3px; margin-left: 10px; border: 1px solid var(--border);">â– </span> Unanswered
        </div>
        <div id="navGrid" class="nav-grid"></div>
        <button onclick="submitExam()" style="padding:15px; background:var(--correct);">
            <i class="fas fa-check-circle"></i> SUBMIT ALL
        </button>
    </aside>
  </div>

  <div id="resultScreen" class="hidden card">
    <div style="text-align:center; padding:20px;">
        <h2>Assessment Summary</h2>
        <div id="resScore" style="font-size:4rem; color:var(--teal); font-weight:800;">0%</div>
        <p id="resInfo" style="color:var(--muted);"></p>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button onclick="printResult()" style="width:auto; padding:10px 30px; background: var(--muted);">
                <i class="fas fa-print"></i> Print
            </button>
            <button onclick="location.reload()" style="width:auto; padding:10px 30px;">
                <i class="fas fa-home"></i> Back to Menu
            </button>
        </div>
    </div>
    <hr>
    
    <div style="padding: 10px;">
        <h3>Review & Master Key</h3>
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterReview('all')">All Questions</button>
            <button class="filter-btn" onclick="filterReview('mcq')">MCQ Only</button>
            <button class="filter-btn" onclick="filterReview('essay')">Essay Only</button>
            <button class="filter-btn" onclick="filterReview('wrong')">Incorrect Only</button>
        </div>
    </div>
    
    <div id="reviewBox"></div>
  </div>
</div>

<div class="autosave-indicator" id="autosaveIndicator">
    <i class="fas fa-check-circle" style="color: var(--correct);"></i>
    <span>Draft saved</span>
</div>

<script>
const USERS = {
    "Sena": { pass: "Sena!32", role: "Student" },
    "Krisna": { pass: "Krisna!32", role: "Admin" },
    "Flint": { pass: "Flint!32", role: "Student" }
};

const BANK = [
    // Section 1: Linear Algebra & Analytical Geometry
    { q: "In a vector space R<sup>n</sup>, what is the specific term for a vector (0, 0, ..., 0) having n zero components?", o: ["Null Unit", "Zero Vector", "Identity Vector", "Negative Vector"], a: 1, e: "The source defines the zero vector of R<sup>n</sup> as a vector where all n components are zero, denoted as 0." },
    { q: "Which property of distance between points states that d(x, y) = d(y, x)?", o: ["Positivity property", "Triangle inequality", "Symmetric property", "Scalar property"], a: 2, e: "In the study of distance between points in R<sup>n</sup>, the property where the distance from x to y is the same as y to x is explicitly called the symmetric property." },
    { q: "Two nonzero vectors u and v are considered orthogonal if and only if:", o: ["Their sum is zero", "Their dot product u Â· v = 0", "Their lengths are equal", "The angle between them is 180Â°"], a: 1, e: "By definition, vectors are orthogonal if the angle between them is a right angle (90Â°), which occurs when the cosine of the angle is 0, resulting in a dot product of zero." },
    { q: "Which of the following is NOT a requirement for identifying a linear equation?", o: ["The exponent of each variable is 1", "Variables are added or subtracted", "There are no radicals in the equation", "Variables can be multiplied together"], a: 3, e: "If variables are multiplied (e.g., xy), the equation becomes non-linear. Linear equations graph as a straight line and must have variables with an exponent of 1." },
    { q: "In coordinate transformations, \"Translation\" is defined as:", o: ["Turning an object about a fixed point", "Sliding an object a fixed distance in a given direction", "Altering the size of an object", "Changing the shape of an object through deformation"], a: 1, e: "Translation is a rigid-body transformation that moves objects by adding offsets to coordinates without changing their shape or size." },
    { q: "What is the standard equation of a line used in analytical geometry?", o: ["xÂ² + yÂ² = rÂ²", "y = axÂ² + bx + c", "y = mx + c", "(x-h)Â² / a - (y-k)Â² / b = 1"], a: 2, e: "The module identifies y = mx + c as the equation of a line, where m is the slope and c is the y-intercept." },
    { q: "In a 2D scaling transformation, if you want to alter the size of an object, you multiply the coordinates by:", o: ["Rotation matrices", "Translation vectors", "Scaling factors s<sub>x</sub> and s<sub>y</sub>", "Determinants"], a: 2, e: "Two-dimensional scaling involves multiplying the x and y coordinates by specific factors to increase or decrease the size of an object." },
    { q: "Which rule is used to solve a system of linear equations by using the determinants of the coefficient matrix?", o: ["Taylor's Rule", "Cramer's Rule", "Gauss Elimination", "Maclaurin's Rule"], a: 1, e: "Cramer's Rule provides a solution for x and y variables in a system by expressing the numerator and denominator as determinants." },

    // Section 2: Differential Calculus
    { q: "A Vector-Valued Function is defined as a function whose:", o: ["Domain is vectors and range is real numbers", "Domain is real numbers and range is a set of vectors", "Domain and range are both real numbers", "Domain and range are both matrices"], a: 1, e: "A vector function assigns a unique vector r(t) to every number t in its domain." },
    { q: "To calculate the gradient of a vector-valued function r(t) = âŸ¨f(t), g(t), h(t)âŸ©, one must:", o: ["Find the integral of each component", "Find the derivative of each component function", "Multiply the components together", "Take the square root of the sum of components"], a: 1, e: "The rule for gradients in vector functions states that r'(t) = âŸ¨f'(t), g'(t), h'(t)âŸ©." },
    { q: "Which series is used to represent a function as a sum of power series centered at 0?", o: ["Taylor series", "Maclaurin series", "Fourier series", "Fibonacci series"], a: 1, e: "The Maclaurin series is specifically noted as a series where the center is 0." },
    { q: "Why are functions represented as series in Geodesy?", o: ["To make them harder to solve", "For integration, limits, and summing complex series", "Only to calculate rotations", "To eliminate the need for matrices"], a: 1, e: "The source lists integration, limits, and finding the sum of a series as the primary \"Why\" for using functions as series." },

    // Section 3: Trigonometry
    { q: "In plane trigonometry, the Tangent function is defined as the ratio of:", o: ["Adjacent leg to Hypotenuse", "Opposite leg to Hypotenuse", "Opposite leg to Adjacent leg", "Hypotenuse to Opposite leg"], a: 2, e: "Trigonometry defines basic functions based on right-triangle ratios; Tangent is Opposite/Adjacent." },
    { q: "What is the term for a curve on the surface of a sphere that crosses every meridian at the same angle?", o: ["Great Circle", "Rhumb Line (Loxodrome)", "Orthodrome", "Geoid"], a: 1, e: "While a Great Circle is the shortest distance, a Rhumb Line maintains a constant direction (azimuth) relative to meridians." },
    { q: "On the surface of a sphere, the interior angles of a triangle sum to:", o: ["Exactly 180Â°", "Over 180Â° and less than 540Â°", "Exactly 360Â°", "Over 540Â°"], a: 1, e: "This phenomenon is known as spherical excess, distinguishing spherical triangles from plane triangles." },

    // Section 4: Statistics & Theory of Errors
    { q: "Which type of phenomenon is one where a mathematical model allows \"perfect\" prediction of the outcome?", o: ["Random phenomenon", "Haphazard phenomenon", "Deterministic phenomenon", "Non-deterministic phenomenon"], a: 2, e: "Deterministic phenomena (common in exact sciences) allow for perfect prediction through mathematical models." },
    { q: "In statistics, \"Standard Deviation\" is a measure of:", o: ["The average value", "Dispersion of observations within a dataset relative to their mean", "The middle value in a set", "The total number of observations"], a: 1, e: "Standard deviation (Ïƒ) quantifies how much the data varies or disperses from the arithmetic mean." },
    { q: "According to the Normal Distribution curve, approximately what percentage of values fall within 2 standard deviations (Î¼ Â± 2Ïƒ)?", o: ["68%", "95%", "99.7%", "50%"], a: 1, e: "The source states that the area between Î¼-2Ïƒ and Î¼+2Ïƒ is about 95% (specifically 95.44%)." },
    { q: "What is the primary purpose of performing \"extra\" (redundant) measurements in surveying?", o: ["To waste time", "To detect outliers (gross errors) and provide consolidated results", "To make the equipment work harder", "To increase the cost of the survey"], a: 1, e: "Redundancy is good practice to provide effective control, detect gross errors, and judge quality (Precision + Reliability)." },
    { q: "Which law describes what happens to measurement errors when uncertain measurements are used to calculate a new quantity?", o: ["Newton's Law", "Law of Large Numbers", "Covariance Propagation Law", "Law of Sines"], a: 2, e: "Also known as error propagation, this law tracks how uncertainties in input estimates affect the combined standard uncertainty of the output." },
    { q: "In the measurement model, the quantity subject to measurement is called the:", o: ["Estimate", "Measurand", "Parameter", "Variable"], a: 1, e: "The measurand is formally defined as the specific quantity intended to be measured." },

    // Section 5: Least Squares & Interpolation
    { q: "The method of Least Squares minimizes the sum of the squares of the:", o: ["Horizontal distances", "Vertical deviations (errors) Îµ", "Input quantities", "Rotation angles"], a: 1, e: "Least Square Estimation works by minimizing the sum of the squares of the deviations of observations from the regression line." },
    { q: "Which interpolation method uses a \"flexible strip\" concept to draw smooth curves through points?", o: ["Lagrange Interpolation", "Spline Interpolation", "Bilinear Interpolation", "IDW"], a: 1, e: "Splines are described as using flexible strips to draw smooth curves, which can be linear, quadratic, or cubic." },
    { q: "In Inverse Distance Weighting (IDW), what happens to the influence of a measured point as it gets farther from the prediction location?", o: ["It increases", "It remains the same", "It decreases", "It becomes infinite"], a: 2, e: "IDW assumes that things close to each other are more alike. As distance increases, the relationship and weight of the point decrease." },
    { q: "A larger power factor (q) in IDW interpolation typically yields:", o: ["A rougher surface", "A smoother surface", "No change in the surface", "A flat plane"], a: 1, e: "The module notes that larger values of q (the power to which distance is raised) yield smoother surfaces." },

    // Section 6: Geodesy & Coordinate Systems
    { q: "What is the fundamental difference between a Reference System and a Reference Frame?", o: ["The System is the physical realization, the Frame is the theory", "The System is the theoretical concept, the Frame is the physical realization", "They are exactly the same", "The System is only for height, the Frame is for 2D"], a: 1, e: "A Reference System is an idealization/theory, while a Reference Frame is the practical realization (like a set of benchmarks)." },
    { q: "Which coordinate system has its origin at the Earth's center of mass?", o: ["Topocentric", "Geocentric", "Heliocentric", "Barycentric"], a: 1, e: "Geocentric systems are centered at the geocenter (Earth's center), whereas topocentric systems are centered on the Earth's surface." },
    { q: "The movement of the Earth's rotation axis relative to the Earth's crust is called:", o: ["Precession", "Nutation", "Polar Motion", "Tectonic Drift"], a: 2, e: "Polar motion is specifically defined as the movement of the rotation axis relative to the crust, unlike precession/nutation which are movements in space." },
    { q: "Which mathematical model is a \"simpler mathematical model than Geoid,\" described as a rotating ellipse?", o: ["Physical Earth Model", "Geoid", "Reference Ellipsoid", "Topographic Surface"], a: 2, e: "The ellipsoid is a mathematical approximation used to simplify geodetic calculations." },
    { q: "The vertical distance from the Geoid to the Earth's surface along the plumb line is called:", o: ["Ellipsoidal Height (h)", "Orthometric Height (H)", "Geoid Undulation (N)", "Dynamic Height"], a: 1, e: "Orthometric height is the natural \"height above sea level\" measured along the plumb line from the geoid." },
    { q: "The relationship between Ellipsoidal height (h), Orthometric height (H), and Geoid undulation (N) is:", o: ["H = h + N", "H = h - N", "h = H - N", "N = H + h"], a: 1, e: "To find the orthometric height (height relative to geoid), you subtract the geoid undulation from the ellipsoidal height obtained from GNSS." },
    { q: "What type of geodetic datum is used in Indonesia to account for its active tectonic characteristics?", o: ["Static Datum", "Semi-Dynamic Datum", "Absolute Datum", "Flat Datum"], a: 1, e: "Because Indonesia is tectonically active, geocentric coordinates change over time, making a Static Datum unsuitable. SRGI 2013 is a Semi-Dynamic Datum." },
    { q: "Which organization legalized SRGI 2013 on 11 October 2013?", o: ["IERS", "BIG (Badan Informasi Geospasial)", "IHO", "NASA"], a: 1, e: "SRGI 2013 (Indonesian Geospatial Reference System) was legalized by BIG." },
    { q: "The \"CIS\" (Conventional Inertial System) is primarily used to:", o: ["Describe the movement of points on the Earth's surface", "Describe the position and motion of satellites", "Measure the depth of the ocean", "Calibrate a Total Station"], a: 1, e: "CIS is a space-fixed system used in satellite geodesy, while CTS is earth-fixed." },

    // Section 7: Map Projections
    { q: "A map projection that preserves angles and shapes of small areas correctly is known as:", o: ["Equal-area", "Conformal", "Equidistant", "Azimuthal"], a: 1, e: "Conformal projections (like Mercator) show angles and small shapes correctly, though they distort area." },
    { q: "The Mercator projection is a type of:", o: ["Conic projection", "Azimuthal projection", "Cylindrical projection", "Pseudo-conic projection"], a: 2, e: "Mercator is defined as a normal cylindrical map projection." },
    { q: "Universal Transverse Mercator (UTM) divides the world into 60 longitudinal zones, each spanning:", o: ["3 degrees", "6 degrees", "10 degrees", "15 degrees"], a: 1, e: "UTM is organized into 60 narrow zones of 6 degrees longitude to minimize distortions." },
    { q: "What is the scale factor given to the central meridian of a UTM zone?", o: ["1.0000", "0.9996", "0.5000", "0.9999"], a: 1, e: "A scale factor of 0.99960 is applied to the central meridian to keep distortions small within the zone." },
    { q: "To avoid negative coordinates in UTM, the central meridian is assigned a \"False Easting\" of:", o: ["0 m", "100,000 m", "500,000 m", "10,000,000 m"], a: 2, e: "The value of 500,000m E is given to the central meridian to ensure all Easting coordinates remain positive." },
    { q: "Which projection shows the shortest distance between two points (Great Circle) as a straight line?", o: ["Mercator", "Gnomonic", "Transverse Mercator", "Lambert Conformal Conic"], a: 1, e: "In a Gnomonic azimuthal projection (listed in use), great circles are straight lines, whereas in Mercator, Rhumb lines are straight." },

    // Section 8: Technical Surveys & GNSS
    { q: "In Levelling, the \"Back Sight\" is the:", o: ["First reading taken at a point of known elevation", "Last reading taken before moving the instrument", "Reading taken in the middle of a loop", "Reading taken with the telescope upside down"], a: 0, e: "Basic levelling involves taking a Back Sight (BS) on a known point and a Fore Sight (FS) on an unknown point to determine height difference." },
    { q: "Which type of level instrument uses barcode staffs and stores readings digitally?", o: ["Dumpy Level", "Automated Level", "Digital Level", "Tilting Level"], a: 2, e: "Digital levels utilize barcode staffs, minimize human error, and allow for automated data storage." },
    { q: "The \"Leap Frog Procedure\" in levelling refers to:", o: ["Jumping over obstacles", "Moving the staff from a back position to a forward position sequentially", "Rotating the level 360 degrees", "Using two levels at the same time"], a: 1, e: "Leap frog is a standard procedure shown in the diagrams for moving staff and instrument along a line." },
    { q: "GNSS stands for:", o: ["Global Navigation Satellite System", "Geodetic Network Satellite System", "General Navigation Space System", "Global Network Survey System"], a: 0, e: "GNSS is the umbrella term for satellite constellations like GPS, Glonass, Galileo, and BeiDou." },
    { q: "Which GNSS positioning method requires two receivers and generally uses the \"double difference\" equation?", o: ["Absolute Positioning", "Single Point Positioning", "Relative Positioning", "Precise Point Positioning (PPP)"], a: 2, e: "Relative positioning requires at least two receivers (base and rover) to produce high-accuracy results." },
    { q: "Which GNSS error is caused by signals reflecting off objects like buildings or the ground before reaching the antenna?", o: ["Ionospheric Bias", "Multipath", "Clock Error", "Satellite Orbit Error"], a: 1, e: "Multipath occurs when the direct signal is combined with reflected signals, causing positional errors." },
    { q: "In RINEX data, what information does the \"approximate position XYZ\" provide?", o: ["The current speed of the satellite", "The estimated 3D Cartesian coordinates of the station", "The antenna height", "The battery level of the receiver"], a: 1, e: "RINEX files must contain approximate XYZ coordinates for post-processing software to work correctly." },
    { q: "An Inertial Measurement Unit (IMU) typically uses a combination of which sensors?", o: ["Compass and Ruler", "Accelerometer, Gyroscope, and Magnetometer", "Thermometer and Barometer", "GPS and Total Station"], a: 1, e: "An IMU measures angular rates and magnetic fields using accelerometers, gyroscopes, and sometimes magnetometers." },
    { q: "In a boat's attitude, \"Pitch\" refers to rotation on which axis?", o: ["X axis (Roll)", "Y axis", "Z axis (Yaw)", "Up axis (Heave)"], a: 1, e: "The module defines Pitch as rotation on the Y axis, Roll as X, and Yaw as Z." },
    { q: "What is the standard confidence level used for measuring accuracy in the survey industry?", o: ["50%", "68%", "95%", "100%"], a: 2, e: "Accuracy standards (including IHO S-44) typically describe uncertainty at a 95% confidence level, corresponding to a z value of approximately 1.96." },

    // --- 25 ESSAYS (REPLACED) ---
    { q: "What is \"Translation\" in coordinate transformations, and how does it work in 2D?", type: "essay", e: "Translation is a type of rigid-body transformation that moves objects without changing their shape or size. In a two-dimensional space, we move an object by sliding it a certain distance in a specific direction. This is done by adding offsets, called t<sub>x</sub> and t<sub>y</sub>, to the original x and y coordinates to find the new positions. For example, if you move a point 6 units to the right, you are performing a translation." },
    { q: "Why do we use power series like the Taylor and Maclaurin series in Geodesy?", type: "essay", e: "We use power series to represent complex functions as a sum of simpler terms. This is very helpful for mathematical tasks like integration, finding limits, and summing complex series. In geodesy, many observation equations are non-linear, so we use the Taylor series to linearize them. The Maclaurin series is a specific type of Taylor series where the center point is zero." },
    { q: "Explain the difference between Plane Trigonometry and Spherical Trigonometry.", type: "essay", e: "Plane trigonometry studies the relationships between the sides and angles of triangles on a flat surface. In a plane triangle, the three interior angles always add up to exactly 180Â°. Spherical trigonometry is used for triangles on the surface of a sphere, like the Earth. On a sphere, the interior angles of a triangle are always more than 180Â° but less than 540Â°. This extra amount over 180Â° is called \"spherical excess\"." },
    { q: "What is a \"Random Variable\" in statistics, and what are the two main types?", type: "essay", e: "A random variable is a symbol that represents numerical values linked to the outcomes of a random experiment. It is basically a function that connects elements in a sample space to real numbers. There are two main types: Discrete and Continuous. Discrete variables involve countable things like the number of sales or people in a line. Continuous variables involve measurements on a scale, such as length, depth, or time." },
    { q: "How do we define Standard Deviation, and why is it important?", type: "essay", e: "Standard deviation, denoted by the symbol Ïƒ, is a measure of how data points are spread out or dispersed relative to their average value (the mean). It tells us if the observations in a dataset are close to the average or far away from it. In surveying, a smaller standard deviation means the measurements are more consistent or precise." },
    { q: "Why is it a good practice to perform \"extra\" or redundant measurements in surveying?", type: "essay", e: "Redundancy is captured in the phrase \"one measure is not a measure,\" meaning we should always take more measurements than the minimum required. These extra measurements help us provide effective control over the results. They allow us to detect \"gross errors\" or outliers that would otherwise ruin the survey. Redundancy also helps us consolidate results to find the best estimate and judge the overall quality, which includes precision and reliability." },
    { q: "Describe the \"Covariance Propagation Law\" in simple terms.", type: "essay", e: "This law explains what happens to measurement errors when you use those uncertain measurements to calculate a new value. For example, if you use a measured distance and angle to calculate a position, the errors in the distance and angle will \"propagate\" or move into the calculated position. Errors usually grow much faster than the sum of the individual mistakes. This law helps us estimate the total uncertainty of our final calculated results." },
    { q: "What is the basic goal of the \"Least Squares\" method?", type: "essay", e: "The goal of Least Squares is to find the best mathematical model that fits a set of measured data points. It estimates parameters by making the sum of the squares of the vertical errors (deviations from the line) as small as possible. We use this to find the \"closest\" solution to a system of equations where we have more observations than unknowns." },
    { q: "Explain how Inverse Distance Weighting (IDW) interpolation works.", type: "essay", e: "IDW is a method used to predict values at locations where we didn't take measurements. It is based on the idea that things close to each other are more alike than things far apart. When predicting a value, measured points that are closer to the location get a higher \"weight\" or influence. As the distance increases, the influence of those measured points decreases." },
    { q: "What is the effect of the \"power factor (q)\" in IDW interpolation?", type: "essay", e: "The power factor q controls how much the influence of a point drops as you get farther away. Larger values of q result in a smoother predicted surface. To get the best results, surveyors often test different values of q to see which one creates the smallest overall error (RMSE)." },
    { q: "What is the difference between a Geodetic Reference System and a Reference Frame?", type: "essay", e: "A Reference System is a theoretical concept or an idealization of how coordinates should work. A Reference Frame is the physical realization of that system. This means a Frame is a set of actual physical points on the Earth's surface (benchmarks) with assigned coordinate values." },
    { q: "Briefly explain the three main motions of the Earth that affect geodesy.", type: "essay", e: "The Earth is always moving, which complicates our coordinate systems. First, it rotates on its own axis, which is not perfectly constant. Second, the rotation axis itself moves in space due to \"Precession and Nutation\". Third, the axis moves relative to the Earth's crust, which is called \"Polar Motion\". These motions mean that coordinates for the same point can change over time." },
    { q: "Why does Indonesia use a \"Semi-Dynamic\" geodetic datum?", type: "essay", e: "Indonesia is located in a very active tectonic area where plates are constantly moving. This movement causes geocentric coordinates to change over time. A \"Static Datum\" is not suitable because it assumes points don't move. A \"Semi-Dynamic Datum\" like SRGI 2013 is used because it represents coordinates at a specific time (epoch) and uses a velocity model to account for tectonic motion." },
    { q: "What are the main characteristics of the WGS 84 coordinate system?", type: "essay", e: "WGS 84 is the earth-fixed Cartesian coordinate system used by GPS. Its origin point is at the Earth's center of mass. The Z-axis follows the Earth's rotation axis, the X-axis is on the Prime Meridian (Greenwich), and the Y-axis is perpendicular to both. It uses a specific reference ellipsoid with defined parameters for its size and flattening." },
    { q: "Describe the Geoid and its relationship to the Ellipsoid and physical Earth.", type: "essay", e: "The physical Earth is irregular and too complex for math. The Geoid is a more useful physical model that connects points with the same gravity potential (sea level). However, the Geoid is still bumpy, so we use a \"Reference Ellipsoid\" as a simpler mathematical model for calculations. The distance between the Ellipsoid and the Geoid is called \"Geoid Undulation\" (N)." },
    { q: "What is a \"Conformal\" map projection, and give an example.", type: "essay", e: "A conformal projection is one that preserves the correct angles and shapes of small areas. While it shows shapes correctly, it usually distorts the size or area of regions. The Mercator projection is a famous example of a conformal cylindrical projection. In a Mercator map, Greenland looks much larger than it actually is compared to South America." },
    { q: "How is the Universal Transverse Mercator (UTM) system organized?", type: "essay", e: "UTM divides the Earth into 60 narrow longitudinal zones, and each zone is 6 degrees wide. This organization helps keep distortions very small within each zone. Each zone has its own central meridian with a scale factor of 0.9996. To avoid negative numbers, the central meridian is given a \"False Easting\" of 500,000 meters." },
    { q: "Explain the difference between \"Back Sight\" and \"Fore Sight\" in levelling.", type: "essay", e: "In the basic principle of levelling, a \"Back Sight\" (BS) is the first reading taken on a point with a known elevation. A \"Fore Sight\" (FS) is the reading taken on a new point whose elevation we want to find. By comparing these two readings, we can calculate the height difference between the two points." },
    { q: "What is \"Relative Positioning\" in GNSS, and why is it used?", type: "essay", e: "Relative positioning requires using at least two GNSS receivers at the same time. One receiver stays at a known point (base station), while the other moves (rover). This method is used because it can cancel out many common errors, like satellite clock or atmospheric delays. This allows surveyors to achieve very high accuracy, often down to the millimeter or centimeter level." },
    { q: "What is a \"Cycle Slip\" in GNSS observations?", type: "essay", e: "A cycle slip is a jump or a break in the carrier phase signal from a satellite. This usually happens when the signal is blocked by an obstruction like a tree or a building. If a cycle slip occurs, the receiver loses its count of the signal waves, which can cause large errors in positioning. Surveyors use techniques like linear regression or Kalman filters to try and fix these slips." },
    { q: "Define \"Orthometric Height\" (H) and how it is obtained.", type: "essay", e: "Orthometric height is the natural \"height above sea level\". It is the vertical distance measured along a plumb line from the Geoid to a point on the Earth's surface. To find it using GNSS, you take the \"Ellipsoidal Height\" (h) from the satellite and subtract the \"Geoid Undulation\" (N) value for that location." },
    { q: "What is an Inertial Measurement Unit (IMU), and what sensors does it contain?", type: "essay", e: "An IMU is an electronic device used to measure the motion, rotation, and orientation of a body, such as a survey boat. It typically uses a combination of three types of sensors: accelerometers (to measure movement), gyroscopes (to measure rotation rates), and magnetometers (to measure magnetic fields)." },
    { q: "Explain the difference between \"Accuracy\" and \"Precision\" using a target analogy.", type: "essay", e: "Accuracy is how close your measurements are to the true or \"bullseye\" value. Precision is how close your measurements are to each other, showing consistency. You can have \"High Precision\" (all shots are in a tight group) but \"Low Accuracy\" (the group is far away from the center). Ideally, a survey should have both high accuracy and high precision." },
    { q: "What are the three main categories of errors in levelling?", type: "essay", e: "Levelling errors are usually divided into three categories: Instrumental, Personal, and Natural. Instrumental errors come from the tool, like a sticking compensator. Personal errors come from the human operator, like reading the staff incorrectly or setting up the tripod poorly. Natural errors come from the environment, like wind, temperature changes, or the curvature of the Earth." },
    { q: "What is the standard confidence level for accuracy in the survey industry, and why?", type: "essay", e: "The industry standard for measuring accuracy is the 95% confidence level. This means that if you take a measurement, you are 95% sure the true value falls within the stated uncertainty range. International standards like IHO S-44 use this 95% level to define how reliable a hydrographic survey must be." }
];

let currentUser = "";
let currentRole = "";
let userAns = {};
let isAdmin = false;
let timerInterval;
let startTime;
let currentQuestionIndex = 0;
let historyData = [];
let currentSortOrder = 'date';

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        if (!document.getElementById('examScreen').classList.contains('hidden')) {
            saveDraft();
        }
    }
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        if (!document.getElementById('examScreen').classList.contains('hidden')) {
            submitExam();
        }
    }
});

function login() {
    let name = document.getElementById('candidateName').value.trim();
    let pass = document.getElementById('candidatePass').value.trim();
    if(USERS[name] && USERS[name].pass === pass) {
        currentUser = name;
        currentRole = USERS[name].role;
        isAdmin = (currentRole === "Admin");
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('menuScreen').classList.remove('hidden');
        const badge = document.getElementById('roleBadge');
        badge.innerText = currentRole.toUpperCase();
        badge.style.background = isAdmin ? "var(--admin-color)" : "var(--teal)";
        badge.style.color = "white";
        document.getElementById('userDisplay').innerHTML = `Candidate: <strong>${currentUser}</strong>`;
        if(isAdmin) {
            document.getElementById('adminTools').classList.remove('hidden');
            document.getElementById('adminCol').classList.remove('hidden');
        }
        loadDraft();
        refreshHistory();
        updateUserStats();
    } else { 
        alert("Access Denied. Please check your credentials."); 
    }
}

function logout() {
    if(confirm("Are you sure you want to logout?")) {
        location.reload();
    }
}

function handleModuleClick() {
    if(isAdmin) {
        if(confirm("Admin Mode: View MASTER KEY?")) showMasterKey();
        else startExam();
    } else startExam();
}

function startExam() {
    userAns = {};
    loadDraft();
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('examScreen').classList.remove('hidden');
    document.getElementById('displayUser').innerText = `Candidate: ${currentUser}`;
    renderQuestions();
    renderNav();
    updateProgress();
    startTime = Date.now();
    timerInterval = setInterval(() => {
        let diff = Math.floor((Date.now() - startTime) / 1000);
        let m = Math.floor(diff/60).toString().padStart(2,'0');
        let s = (diff%60).toString().padStart(2,'0');
        document.getElementById('timerDisplay').innerText = `${m}:${s}`;
    }, 1000);
}

function renderQuestions() {
    const box = document.getElementById('qBox');
    box.innerHTML = BANK.map((q, i) => {
        let inputArea = "";
        const badge = q.type === 'essay' ? '<span class="badge-essay">ESSAY</span>' : '<span class="badge-mcq">MCQ</span>';
        
        if(q.type === 'essay') {
            const text = userAns[i] || "";
            const charCount = text.length;
            const charClass = charCount < 50 ? 'warning' : '';
            inputArea = `
                <textarea id="essay_${i}" placeholder="Type your answer here... (Minimum 50 characters recommended)" oninput="saveEssay(${i}, this.value)">${text}</textarea>
                <div class="char-counter ${charClass}">
                    <i class="fas fa-keyboard"></i> ${charCount} characters
                </div>
            `;
        } else {
            const lbl = ['A', 'B', 'C', 'D'];
            inputArea = q.o.map((text, oi) => `
                <div class="option ${userAns[i] === oi ? 'selected' : ''}" onclick="saveMCQ(${i}, ${oi})">
                    <strong>${lbl[oi]}.</strong> ${text}
                </div>
            `).join('');
        }

        return `
            <div class="card" id="q_${i}">
                <p><strong>Question ${i+1} of ${BANK.length}</strong> ${badge}</p>
                <p style="font-size: 1.05rem; line-height: 1.7;">${q.q}</p>
                ${inputArea}
            </div>
        `;
    }).join('');
}

function saveMCQ(idx, val) {
    userAns[idx] = val;
    renderNav();
    renderQuestions();
    updateProgress();
    autoSaveDraft();
}

function saveEssay(idx, text) {
    userAns[idx] = text;
    renderNav();
    updateProgress();
    autoSaveDraft();
}

function renderNav() {
    document.getElementById('navGrid').innerHTML = BANK.map((_, i) => {
        const isAnswered = userAns.hasOwnProperty(i) && (typeof userAns[i] === 'number' || (userAns[i] && userAns[i].trim().length > 0));
        const isCurrent = currentQuestionIndex === i;
        return `<div class="nav-btn ${isAnswered ? 'answered' : ''} ${isCurrent ? 'current' : ''}" 
                     onclick="jumpToQuestion(${i})" 
                     title="Question ${i+1}">${i+1}</div>`;
    }).join('');
}

function jumpToQuestion(idx) {
    currentQuestionIndex = idx;
    document.getElementById(`q_${idx}`).scrollIntoView({behavior:'smooth', block:'center'});
    renderNav();
}

function updateProgress() {
    let answered = 0;
    let mcqAnswered = 0;
    let essayAnswered = 0;
    
    BANK.forEach((q, i) => {
        const hasAnswer = userAns.hasOwnProperty(i) && (typeof userAns[i] === 'number' || (userAns[i] && userAns[i].trim().length > 0));
        if(hasAnswer) {
            answered++;
            if(q.type === 'essay') essayAnswered++;
            else mcqAnswered++;
        }
    });
    
    const progress = (answered / BANK.length) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').innerText = `${answered}/${BANK.length}`;
    document.getElementById('mcqCount').innerText = `${mcqAnswered}/50`;
    document.getElementById('essayCount').innerText = `${essayAnswered}/25`;
}

function saveDraft() {
    const draftKey = `krisna_pg01_draft_${currentUser}`;
    localStorage.setItem(draftKey, JSON.stringify(userAns));
    showAutosaveIndicator();
}

function loadDraft() {
    const draftKey = `krisna_pg01_draft_${currentUser}`;
    const draft = localStorage.getItem(draftKey);
    if(draft) {
        userAns = JSON.parse(draft);
    }
}

function autoSaveDraft() {
    clearTimeout(window.autosaveTimeout);
    window.autosaveTimeout = setTimeout(() => {
        saveDraft();
    }, 2000);
}

function showAutosaveIndicator() {
    const indicator = document.getElementById('autosaveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function submitExam() {
    const unanswered = BANK.length - Object.keys(userAns).filter(k => {
        const val = userAns[k];
        return typeof val === 'number' || (val && val.trim().length > 0);
    }).length;
    
    let confirmMsg = "Submit your exam now?";
    if(unanswered > 0) {
        confirmMsg = `You have ${unanswered} unanswered questions. Submit anyway?`;
    }
    
    if(!confirm(confirmMsg)) return;
    
    clearInterval(timerInterval);
    
    let mcqScore = 0;
    let essayAttempted = 0;
    
    BANK.forEach((q, i) => {
        if(q.type === 'essay') {
            if(userAns[i] && userAns[i].trim().length > 10) essayAttempted++;
        } else {
            if(userAns[i] === q.a) mcqScore++;
        }
    });

    const totalPossible = BANK.length;
    const finalScore = Math.round(((mcqScore + essayAttempted) / totalPossible) * 100);
    
    const draftKey = `krisna_pg01_draft_${currentUser}`;
    localStorage.removeItem(draftKey);
    
    saveRecord(finalScore);
    showResult(finalScore, `MCQ Correct: ${mcqScore}/50 | Essay Attempted: ${essayAttempted}/25`);
}

function showResult(pct, info) {
    document.getElementById('examScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    document.getElementById('resScore').innerText = (pct === "KEY" ? "MASTER KEY" : pct + "%");
    document.getElementById('resInfo').innerText = info;
    
    renderReview();
}

function renderReview() {
    const lbl = ['A', 'B', 'C', 'D'];
    document.getElementById('reviewBox').innerHTML = BANK.map((q, i) => {
        if(q.type === 'essay') {
            return `
                <div class="card review-item" data-type="essay" data-correct="true">
                    <p><strong>${i+1}. ${q.q}</strong> <span class="badge-essay">ESSAY</span></p>
                    <div class="user-essay-box">
                        <strong><i class="fas fa-user"></i> Your Answer:</strong><br>
                        ${userAns[i] || "<em style='color: var(--muted);'>(No answer provided)</em>"}
                    </div>
                    <div class="model-answer-box">
                        <strong><i class="fas fa-graduation-cap"></i> Model Answer:</strong><br>
                        ${q.e}
                    </div>
                </div>
            `;
        } else {
            const isCorrect = userAns[i] === q.a;
            let opts = q.o.map((text, oi) => {
                let cls = (oi === q.a) ? 'correct-view' : (userAns[i] === oi ? 'wrong-view' : '');
                let icon = (oi === q.a) ? '<i class="fas fa-check-circle" style="color: var(--correct); float: right;"></i>' : '';
                if(userAns[i] === oi && oi !== q.a) {
                    icon = '<i class="fas fa-times-circle" style="color: var(--wrong); float: right;"></i>';
                }
                return `<div class="option ${cls}"><strong>${lbl[oi]}.</strong> ${text} ${icon}</div>`;
            }).join('');
            return `
                <div class="card review-item" data-type="mcq" data-correct="${isCorrect}">
                    <p><strong>${i+1}. ${q.q}</strong> <span class="badge-mcq">MCQ</span></p>
                    ${opts}
                    <div class="explanation-box">
                        <strong><i class="fas fa-lightbulb"></i> Discussion:</strong><br>
                        ${q.e}
                    </div>
                </div>
            `;
        }
    }).join('');
}

function filterReview(type) {
    document.querySelectorAll('.filter-bar .filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    const items = document.querySelectorAll('.review-item');
    items.forEach(item => {
        if(type === 'all') {
            item.style.display = 'block';
        } else if(type === 'mcq') {
            item.style.display = item.dataset.type === 'mcq' ? 'block' : 'none';
        } else if(type === 'essay') {
            item.style.display = item.dataset.type === 'essay' ? 'block' : 'none';
        } else if(type === 'wrong') {
            item.style.display = item.dataset.correct === 'false' ? 'block' : 'none';
        }
    });
}

function showMasterKey() {
    userAns = {};
    BANK.forEach((q, i) => {
        if(q.type !== 'essay') {
            userAns[i] = q.a;
        }
    });
    showResult("KEY", "Master Key - All correct answers and model essays displayed");
}

function saveRecord(s) {
    let data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    data.push({
        n: currentUser, 
        s: s, 
        d: new Date().toLocaleString(),
        timestamp: Date.now()
    });
    localStorage.setItem('krisna_pg01_db', JSON.stringify(data));
}

function refreshHistory() {
    historyData = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    displayHistory(historyData);
}

function displayHistory(data) {
    const tbody = document.getElementById('histBody');
    if(data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;"><i class="fas fa-inbox"></i><br>No exam history yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.slice().reverse().map((h, i) => {
        const scoreColor = h.s >= 80 ? 'var(--correct)' : h.s >= 60 ? 'var(--warning)' : 'var(--wrong)';
        return `
            <tr>
                <td style="padding:10px; border-bottom:1px solid #eee;">
                    <i class="fas fa-user-circle" style="color: var(--teal); margin-right: 5px;"></i>
                    ${h.n}
                </td>
                <td style="padding:10px; border-bottom:1px solid #eee;">
                    <strong style="color: ${scoreColor}; font-size: 1.1rem;">${h.s}%</strong>
                </td>
                <td style="padding:10px; border-bottom:1px solid #eee;">
                    <small><i class="fas fa-clock" style="color: var(--muted); margin-right: 3px;"></i>${h.d}</small>
                </td>
                <td class="${isAdmin?'':'hidden'}" style="text-align:center; border-bottom:1px solid #eee;">
                    <button onclick="deleteSingle(${data.length-1-i})" style="background:none; color:red; width:auto; padding:5px 10px; border: 1px solid red; border-radius: 4px;" title="Delete this record">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterHistory() {
    const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
    const filtered = historyData.filter(h => h.n.toLowerCase().includes(searchTerm));
    displayHistory(filtered);
}

function sortHistory(type) {
    document.querySelectorAll('.filter-bar .filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    let sorted = [...historyData];
    if(type === 'date') {
        sorted.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    } else if(type === 'score') {
        sorted.sort((a, b) => b.s - a.s);
    } else if(type === 'name') {
        sorted.sort((a, b) => a.n.localeCompare(b.n));
    }
    displayHistory(sorted);
}

function updateUserStats() {
    const data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    const userRecords = data.filter(h => h.n === currentUser);
    
    if(userRecords.length === 0) {
        document.getElementById('userAttempts').innerText = '0';
        document.getElementById('userBestScore').innerText = '-';
        document.getElementById('userAvgScore').innerText = '-';
        document.getElementById('userLastDate').innerText = '-';
        return;
    }
    
    const scores = userRecords.map(h => h.s);
    const best = Math.max(...scores);
    const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
    const lastDate = userRecords[userRecords.length - 1].d.split(',')[0];
    
    document.getElementById('userAttempts').innerText = userRecords.length;
    document.getElementById('userBestScore').innerText = best + '%';
    document.getElementById('userAvgScore').innerText = avg + '%';
    document.getElementById('userLastDate').innerText = lastDate;
}

function deleteSingle(i) {
    if(!confirm("Delete this record permanently?")) return;
    let data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    data.splice(i, 1);
    localStorage.setItem('krisna_pg01_db', JSON.stringify(data));
    refreshHistory();
    updateUserStats();
}

function clearAllData() { 
    if(confirm("âš ï¸ WARNING: This will permanently delete ALL exam records. Continue?")) { 
        if(confirm("Are you absolutely sure? This action cannot be undone!")) {
            localStorage.removeItem('krisna_pg01_db'); 
            refreshHistory(); 
            updateUserStats();
            alert("All data has been cleared.");
        }
    } 
}

function exportCSV() {
    let data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    let csv = "Candidate,Score,Date,Timestamp\n" + data.map(h => 
        `"${h.n}",${h.s},"${h.d}","${h.timestamp || ''}"`
    ).join('\n');
    downloadFile(csv, 'PG01_Results.csv', 'text/csv');
}

function exportJSON() {
    let data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    const json = JSON.stringify(data, null, 2);
    downloadFile(json, 'PG01_Results.json', 'application/json');
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], {type: type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
}

function printResult() {
    window.print();
}

function exitExam() { 
    if(confirm("Exit exam? Your progress will be saved as draft.")) {
        saveDraft();
        clearInterval(timerInterval);
        location.reload();
    }
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const icon = document.querySelector('.theme-toggle i');
    if(document.body.classList.contains('dark-mode')) {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
        localStorage.setItem('darkMode', 'enabled');
    } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
        localStorage.setItem('darkMode', 'disabled');
    }
}

window.addEventListener('DOMContentLoaded', () => {
    if(localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-mode');
        document.querySelector('.theme-toggle i').classList.replace('fa-moon', 'fa-sun');
    }
});

</script>
</body>
</html>
