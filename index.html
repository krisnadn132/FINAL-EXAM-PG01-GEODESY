<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Krisna Exam System - FINAL EXAM PG01 GEODESY</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #2d3436;
  --muted: #636e72;
  --teal: #008080;
  --teal-light: #e0f2f2;
  --correct: #27ae60;
  --wrong: #d63031;
  --border: #dfe6e9;
  --admin-color: #6c5ce7;
  --info-bg: #e1f5fe;
  --essay-color: #e67e22;
}

* { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
body { margin: 0; background: var(--bg); color: var(--text); line-height: 1.6; }

header { background: var(--card); border-bottom: 3px solid var(--teal); box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 10px 20px; position: sticky; top: 0; z-index: 1000; }
.header-inner { max-width: 1200px; margin: auto; display: flex; justify-content: space-between; align-items: center; }
h1 { margin: 0; color: var(--teal); font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }

.container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
.card { background: var(--card); border-radius: 8px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); }

.exam-grid { display: grid; grid-template-columns: 260px 1fr 260px; gap: 20px; align-items: start; }
.sidebar-left, .sidebar-right { position: sticky; top: 80px; background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
.sidebar-left { border-left: 4px solid var(--teal); }
.sidebar-right { border-right: 4px solid var(--teal); }

.timer-box { font-size: 1.8rem; font-weight: bold; text-align: center; margin: 15px 0; padding: 10px; background: var(--bg); border-radius: 5px; border: 1px solid var(--border); }

.nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; }
.nav-btn { padding: 8px 0; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.7rem; }
.nav-btn.answered { background: var(--teal); color: white; border-color: var(--teal); }

.option { display: block; border: 1px solid var(--border); padding: 12px 15px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; position: relative; }
.option.selected { border-color: var(--teal); background: var(--teal-light); font-weight: 600; }
.correct-view { background: #d4edda; border-color: #c3e6cb; color: #155724; }
.wrong-view { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }

.explanation-box { background: var(--info-bg); padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #0288d1; font-size: 0.9rem; }
.badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; color: white; }
.badge-mcq { background: var(--teal); }
.badge-essay { background: var(--essay-color); }

button { background: var(--teal); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
button:hover { opacity: 0.9; transform: translateY(-1px); }
button.secondary { background: var(--muted); }
button.danger { background: var(--wrong); }

input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
.hidden { display: none !important; }

@media (max-width: 900px) {
    .exam-grid { display: block; }
    .sidebar-left, .sidebar-right { position: relative; top: 0; width: 100%; margin-bottom: 20px; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex; align-items:center; gap:10px;">
        <i class="fas fa-globe-americas" style="color:var(--teal); font-size:1.5rem;"></i>
        <h1>Krisna Exam System <small style="font-size:0.6rem; opacity:0.7;">PG01 COMPREHENSIVE</small></h1>
    </div>
    <div id="userDisplay" style="font-weight:bold; color:var(--muted);"></div>
  </div>
</header>

<div class="container">
  <div id="startScreen" class="card" style="max-width:400px; margin: 60px auto; text-align:center;">
    <h2 style="color:var(--teal)">PG01 FINAL EXAM</h2>
    <input type="text" id="candidateName" placeholder="Username">
    <input type="password" id="candidatePass" placeholder="Password">
    <button onclick="login()">SECURE LOGIN <i class="fas fa-key"></i></button>
  </div>

  <div id="menuScreen" class="hidden">
    <div class="card">
        <h3>Module: Geodesy Fundamentals</h3>
        <div id="roleBadge" style="display:inline-block; margin-bottom:20px;"></div>
        <button onclick="startExam()" style="padding:25px; font-size:1.2rem; text-align:left;">
            <i class="fas fa-play-circle"></i> START FINAL EXAM (50 MCQ + 25 Essay)
        </button>
    </div>
    
    <div class="card">
        <h4>Results Dashboard</h4>
        <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                <thead><tr style="background:#f8f9fa;">
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Candidate</th>
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Score</th>
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Date</th>
                    <th id="adminCol" class="hidden" style="padding:10px; border-bottom:1px solid #ddd; text-align:center;">Action</th>
                </tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="examScreen" class="exam-grid hidden">
    <aside class="sidebar-left">
        <h3>Exam Info</h3>
        <p id="infoUser" style="font-size:0.8rem; color:var(--muted);"></p>
        <div class="timer-box" id="timerDisplay">00:00</div>
        <button onclick="exitExam()" class="secondary">Abort Exam</button>
    </aside>

    <section id="qBox"></section>

    <aside class="sidebar-right">
        <h4>Question Map</h4>
        <div id="navGrid" class="nav-grid"></div>
        <button onclick="submitExam()" style="padding:15px; background:var(--correct);">FINISH <i class="fas fa-check-double"></i></button>
    </aside>
  </div>

  <div id="resultScreen" class="hidden card">
    <div style="text-align:center; padding:20px;">
        <h2>Exam Summary</h2>
        <div id="resScore" style="font-size:4rem; color:var(--teal); font-weight:800;">0%</div>
        <p id="resInfo"></p>
        <button onclick="location.reload()" style="width:auto; padding:10px 40px;">Exit to Menu</button>
    </div>
    <hr>
    <div id="reviewBox"></div>
  </div>
</div>

<script>
const USERS = {
    "Sena": { pass: "Sena!32", role: "Student" },
    "Krisna": { pass: "Krisna!32", role: "Admin" },
    "Flint": { pass: "Flint!32", role: "Student" }
};

const BANK = [
    // 50 MULTIPLE CHOICE
    { q: "According to the PDF, which statement is correct regarding measurement?", o: ["A single measurement is sufficient", "Every measurement is exact", "Every measurement contains errors", "True value is always known"], a: 2, e: "The PDF explicitly states that every measurement contains errors and the true value is never known." },
    { q: "The true value of a measurement is:", o: ["Always measurable", "Known after averaging", "Never known", "Equal to the mean"], a: 2, e: "The material clearly states the true value is never known." },
    { q: "Quality of measurement is defined as:", o: ["Accuracy only", "Precision only", "Precision + Reliability", "Mean + Standard deviation"], a: 2, e: "The PDF defines quality as Precision + Reliability." },
    { q: "Which statistical value indicates dispersion?", o: ["Mean", "Median", "Standard deviation", "Minimum"], a: 2, e: "Standard deviation measures the spread or dispersion of data points." },
    { q: "For 95% confidence level, the z-value is:", o: ["1.00", "1.64", "1.96", "2.58"], a: 2, e: "The PDF specifies z = 1.96 for 95% confidence." },
    { q: "Error propagation occurs when:", o: ["Repeating the same measurement", "Using uncertain measurements in calculations", "Ignoring systematic errors", "Using GPS only"], a: 1, e: "Error propagation is defined when uncertain measurements are used to compute derived quantities." },
    { q: "For multiplication/division, relative uncertainty is combined by:", o: ["Direct summation", "Squared addition", "Square root of squared relative uncertainties", "Subtraction"], a: 2, e: "Formula for relative uncertainty uses the square root of the sum of squared individual relative uncertainties." },
    { q: "The least squares method minimizes:", o: ["Absolute errors", "Sum of residuals", "Sum of squared residuals", "Maximum deviation"], a: 2, e: "Least squares seeks to minimize the sum of the squares of the differences between observed and calculated values." },
    { q: "The normal equations in least squares are derived from:", o: ["Integration", "Differentiation", "Summation", "Projection"], a: 1, e: "Normal equations are obtained by differentiating the objective function (sum of squares) and setting it to zero." },
    { q: "Redundant measurements help to:", o: ["Increase error", "Detect gross errors", "Reduce time", "Remove variance"], a: 1, e: "Redundancy (extra measurements) is used to detect outliers and blunders." },
    { q: "Lagrange interpolation is used to:", o: ["Estimate unknown values between known points", "Reduce systematic errors", "Convert coordinates", "Transform datums"], a: 0, e: "Lagrange interpolation calculates a polynomial that passes through all given points to estimate values in between." },
    { q: "Inverse Distance Weighting (IDW) assumes:", o: ["Far points are more similar", "Close points are more alike", "All points have equal weight", "Only two points are used"], a: 1, e: "IDW is based on the principle that spatial correlation decreases with distance." },
    { q: "Cross-validation in interpolation is used to:", o: ["Increase grid density", "Check interpolation accuracy", "Change projection", "Reduce variance"], a: 1, e: "It tests how well the interpolation predicts values by temporarily removing known points." },
    { q: "Quadratic spline interpolation uses:", o: ["First-order polynomial", "Second-order polynomial", "Third-order polynomial", "Constant value"], a: 1, e: "Spline interpolation uses piecewise second-order polynomials for quadratic splines." },
    { q: "Spline interpolation ensures:", o: ["Discontinuous surface", "Smooth connection at knots", "No slope continuity", "No curvature"], a: 1, e: "Splines ensure continuity and smoothness at the junction points (knots)." },
    { q: "The Earth is approximated mathematically by:", o: ["Cube", "Plane", "Ellipsoid", "Cone"], a: 2, e: "A reference ellipsoid is the most practical mathematical model for the Earth's shape." },
    { q: "WGS-84 semi-major axis is approximately:", o: ["6,356,752 m", "6,378,137 m", "6,400,000 m", "6,350,000 m"], a: 1, e: "This is the 'a' parameter for the WGS-84 ellipsoid used by GPS." },
    { q: "Geoid represents:", o: ["Mathematical ellipsoid", "Physical gravity surface", "Plane projection", "Satellite orbit"], a: 1, e: "The Geoid is the equipotential surface of the Earth's gravity field." },
    { q: "A Coordinate Reference System (CRS) is:", o: ["Practical realization only", "Theoretical definition including parameters", "Projection formula only", "Benchmark list"], a: 1, e: "CRS is the abstract mathematical framework for coordinate definition." },
    { q: "A Coordinate Reference Frame (CRF) is:", o: ["Theoretical system", "Mathematical model", "Practical realization of CRS", "Datum only"], a: 2, e: "CRF is the physical realization (coordinates of actual points) of a CRS." },
    { q: "A map projection represents:", o: ["Plane on sphere", "Sphere on plane", "Datum transformation", "Satellite orbit"], a: 1, e: "Map projection maps the 3D Earth onto a 2D flat surface." },
    { q: "UTM belongs to:", o: ["Conical projection", "Cylindrical projection", "Azimuthal projection", "Polyhedral projection"], a: 1, e: "UTM uses the Transverse Mercator, which is a cylindrical projection." },
    { q: "Projection distortion increases:", o: ["Toward equator only", "Away from central reference line", "At datum", "At origin only"], a: 1, e: "Distortion grows as the distance from the point or line of tangency/secancy increases." },
    { q: "Geographic Coordinate System includes:", o: ["Prime meridian, angular unit, datum", "Easting and Northing only", "Scale factor only", "Grid convergence only"], a: 0, e: "GCS uses angular measures (Lat/Lon) based on a datum and prime meridian." },
    { q: "Planimetric coordinates are:", o: ["(φ, λ)", "(X,Y,Z)", "(E,N)", "(Lat, Lon, h)"], a: 2, e: "Planimetric or grid coordinates are expressed as Easting (E) and Northing (N)." },
    { q: "4D coordinates include:", o: ["Latitude and Longitude", "Height only", "Latitude, Longitude, Height, Time", "Easting and Northing"], a: 2, e: "The 4th dimension in modern geodesy is time, representing tectonic movement." },
    { q: "Geocentric coordinates are:", o: ["(φ, λ)", "(E,N)", "(X,Y,Z)", "(h only)"], a: 2, e: "Geocentric Cartesian coordinates use an X, Y, Z system centered on Earth's mass." },
    { q: "Topocentric coordinates are:", o: ["Local x,y,z", "Ellipsoidal", "Astronomical", "Geocentric"], a: 0, e: "Topocentric systems are centered on a local point on the Earth's surface." },
    { q: "CIS stands for:", o: ["Conventional Inertial System", "Central International System", "Cylindrical Integrated System", "Celestial Integrated System"], a: 0, e: "A space-fixed reference system used for satellite orbits." },
    { q: "CTS stands for:", o: ["Conventional Terrestrial System", "Cylindrical Terrestrial System", "Central Tracking System", "Coordinate Terrestrial System"], a: 0, e: "An Earth-fixed reference system that rotates with the planet." },
    { q: "Orthometric height is derived using:", o: ["Ellipsoidal height only", "Geoid only", "Ellipsoidal height and geoid undulation", "Projection formula"], a: 2, e: "H = h - N, where H is orthometric, h is ellipsoidal, and N is geoid height." },
    { q: "TVU formula is:", o: ["a + bd", "√(a² + (bd)²)", "a² + b²", "bd"], a: 1, e: "The IHO S-44 standard formula for vertical uncertainty." },
    { q: "In IHO S-44, parameters a and b depend on:", o: ["Projection", "Survey order", "Datum", "GNSS type"], a: 1, e: "Constants 'a' and 'b' are specified for Special, Order 1, and Order 2 surveys." },
    { q: "Vessel motion errors include:", o: ["Yaw only", "Roll, pitch, heave", "Speed only", "Heading only"], a: 1, e: "Roll, Pitch, and Heave are the primary dynamic motions affecting sonar." },
    { q: "Sound speed errors affect:", o: ["Horizontal position", "Bathymetric depth", "Datum transformation", "Projection"], a: 1, e: "Sound velocity errors directly cause scale and refraction errors in depth." },
    { q: "INS uses:", o: ["Satellites only", "Accelerometers and gyros", "Radar only", "Echo sounder"], a: 1, e: "The Inertial Measurement Unit consists of accelerometers and gyroscopes." },
    { q: "GNSS aiding improves INS by:", o: ["Replacing accelerometers", "Providing independent position", "Eliminating drift", "Removing gyros"], a: 1, e: "GNSS provides external absolute position to reset INS drift errors." },
    { q: "Kalman filter is used to:", o: ["Convert projection", "Blend GNSS and INS", "Compute geoid", "Detect tide"], a: 1, e: "It is an optimal estimator used to fuse sensor data with mathematical models." },
    { q: "Strapdown INS means:", o: ["Rotating platform", "Sensors fixed to body frame", "Satellite-based", "Optical system"], a: 1, e: "In strapdown systems, sensors are rigidly attached to the vehicle body." },
    { q: "INS errors grow due to:", o: ["Datum shift", "Sensor and initial condition errors", "Projection distortion", "Tidal correction"], a: 1, e: "Drift and biases in accelerometers and gyros integrate into position error." },
    { q: "Plane surveying ignores:", o: ["Projection", "Earth curvature", "Datum", "Coordinates"], a: 1, e: "Plane surveying assumes a flat Earth surface." },
    { q: "Geodetic surveying considers:", o: ["Flat Earth", "Small areas only", "Earth curvature", "No adjustment"], a: 2, e: "Geodetic surveying accounts for the Earth's curved shape." },
    { q: "Plane surveying area coverage is:", o: [">250 km²", "<250 km²", "Global", "Polar only"], a: 1, e: "The threshold where Earth's curvature becomes significant is approx. 250 km²." },
    { q: "Astronomical surveying determines position using:", o: ["Satellites", "Sea depth", "Celestial objects", "Radar"], a: 2, e: "Observation of stars and planets for position/azimuth." },
    { q: "Marine/hydrographic surveying includes:", o: ["Road measurement", "Seafloor measurement", "Airborne lidar only", "Plane triangulation"], a: 1, e: "It focuses on charting the underwater environment." },
    { q: "Geodetic transformation may use:", o: ["Geocentric translation", "Interpolation only", "INS only", "Projection formula"], a: 0, e: "The simplest transformation is the 3-parameter geocentric translation (X,Y,Z shift)." },
    { q: "Ellipsoid parameters include:", o: ["Prime meridian only", "Semi-major axis and flattening", "Zone number", "Scale factor only"], a: 1, e: "An ellipsoid is defined by its size (a) and its shape (f)." },
    { q: "ITRF epochs indicate:", o: ["Projection type", "Time dependency of coordinates", "Datum height", "Tidal range"], a: 1, e: "ITRF coordinates change due to plate tectonics, hence epochs are required." },
    { q: "Reference ellipsoid is used because:", o: ["Earth is flat", "It simplifies calculations", "It equals geoid", "It removes gravity"], a: 1, e: "The ellipsoid is a smooth geometric shape easy to work with mathematically." },
    { q: "Height systems require:", o: ["Projection only", "Ellipsoid only", "Geoid model and benchmarks", "INS only"], a: 2, e: "To relate GPS height to sea level, geoid undulation and benchmarks are needed." },

    // 25 ESSAY QUESTIONS
    { type: "essay", q: "Explain why 'one measure is not a measure' in geodetic surveying.", e: "Every measurement contains errors and the true value is never known. A single measurement cannot detect gross errors or mistakes. By repeating measurements (redundancy), we can compare results, compute mean and standard deviation, and ensure reliability." },
    { type: "essay", q: "Explain the difference between precision and reliability.", e: "Precision is the closeness of repeated measurements to each other (low spread). Reliability is the ability of a system to detect errors through redundancy. Quality is the combination of both." },
    { type: "essay", q: "Explain the concept of error propagation.", e: "When uncertain measurements are used to calculate derived values (like computing Area from Width and Length), the uncertainty of the inputs transfers to the final result, often growing in magnitude." },
    { type: "essay", q: "Explain the least squares method and its purpose.", e: "It is a mathematical adjustment that minimizes the sum of the squares of residuals. It provides the most consistent estimate for unknowns in a system with redundant data." },
    { type: "essay", q: "Explain what is meant by a reference ellipsoid.", e: "It is a mathematical oblate spheroid that approximates the Earth's shape. It provides a simple surface for performing geodetic calculations instead of using the complex real Earth." },
    { type: "essay", q: "Explain the difference between geoid and ellipsoid.", e: "The geoid is a physical gravity-based surface (Mean Sea Level). The ellipsoid is a smooth mathematical model. The geoid is irregular due to mass distribution, while the ellipsoid is uniform." },
    { type: "essay", q: "Explain what a Coordinate Reference System (CRS) is.", e: "CRS is a theoretical abstract framework that defines the parameters (datum, ellipsoid, units) for coordinate measurement." },
    { type: "essay", q: "Explain what a Coordinate Reference Frame (CRF) is.", e: "CRF is the practical realization of a CRS, consisting of actual coordinates assigned to a network of physical benchmarks." },
    { type: "essay", q: "Explain what 4D coordinates mean in modern geodesy.", e: "It includes 3D position (Lat, Lon, Height) plus Time. Time is essential because the Earth's crust moves due to tectonic activities." },
    { type: "essay", q: "Explain the purpose of map projection.", e: "Since the Earth is curved and paper/screens are flat, projection is the mathematical transformation used to represent geographic coordinates on a flat plane." },
    { type: "essay", q: "Explain distortion in map projections.", e: "Distortion is the inevitable warping of shapes, areas, or distances that occurs when flattening a sphere. It is usually smallest at the point of contact and grows away from it." },
    { type: "essay", q: "Explain the UTM projection system.", e: "Universal Transverse Mercator divides the globe into 60 zones. It is a conformal cylindrical projection used to minimize distortion in local mapping." },
    { type: "essay", q: "Explain the difference between geocentric and geodetic coordinates.", e: "Geocentric coordinates (X,Y,Z) use a 3D Cartesian system from Earth's center. Geodetic coordinates (Lat, Lon, h) use angles and ellipsoidal height." },
    { type: "essay", q: "Explain the concept of CIS and CTS.", e: "CIS (Conventional Inertial System) is space-fixed (for satellite orbits). CTS (Conventional Terrestrial System) is Earth-fixed and rotates with the planet." },
    { type: "essay", q: "Explain orthometric height computation using GNSS.", e: "H = h - N. One takes the ellipsoidal height (h) from GNSS and subtracts the geoid undulation (N) from a gravity model to get the height above sea level (H)." },
    { type: "essay", q: "Explain Total Vertical Uncertainty (TVU).", e: "TVU represents the depth uncertainty at a 95% confidence level, combining fixed errors (a) and depth-dependent errors (b*d)." },
    { type: "essay", q: "Explain why sound speed affects depth measurement.", e: "Sonar measures time. Depth = (Speed * Time) / 2. If the speed of sound is inaccurate, the depth calculation will be scaled incorrectly." },
    { type: "essay", q: "Explain vessel motion errors in hydrographic survey.", e: "Roll, Pitch, and Heave change the sonar transducer's orientation and position. If not corrected, they cause false 'artifacts' on the seafloor map." },
    { type: "essay", q: "Explain the principle of Inertial Navigation System (INS).", e: "It uses an IMU to measure acceleration and rotation. By integrating these over time, it tracks position from a known starting point without external signals." },
    { type: "essay", q: "Explain GNSS aiding of INS.", e: "GNSS provides an external absolute reference. A Kalman filter uses GNSS data to periodically correct the drift and bias errors inherent in the INS." },
    { type: "essay", q: "Explain the classification of plane and geodetic surveying.", e: "Plane surveying treats the Earth as flat (small areas). Geodetic surveying accounts for Earth's curvature (large areas/global)." },
    { type: "essay", q: "Explain the importance of ITRF epochs.", e: "Since tectonic plates move several cm/year, a coordinate is only meaningful if we know the 'Epoch' (date) it was recorded." },
    { type: "essay", q: "Explain why map projection is necessary in hydrography.", e: "Navigators need flat charts for planning. Projection converts curved coordinates into planar Eastings/Northings for drawing maps." },
    { type: "essay", q: "Explain the role of redundancy in survey adjustment.", e: "Redundancy provides the 'extra' data needed to check for blunders, calculate statistical reliability, and improve accuracy through adjustment." },
    { type: "essay", q: "Explain why vertical datum errors are critical in hydrographic surveying.", e: "Depths must be referenced to a Chart Datum (usually low water). Errors here can lead to ships grounding if the depth is overestimated." }
];

let currentUser = "";
let userAns = {};
let timerInterval;
let startTime;

// --- CORE FUNCTIONS ---

function login() {
    let n = document.getElementById('candidateName').value;
    let p = document.getElementById('candidatePass').value;
    if(USERS[n] && USERS[n].pass === p) {
        currentUser = n;
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('menuScreen').classList.remove('hidden');
        document.getElementById('userDisplay').innerText = `User: ${n}`;
        let rb = document.getElementById('roleBadge');
        rb.innerHTML = `<span class="badge" style="background:${USERS[n].role==='Admin'?'var(--admin-color)':'var(--teal)'}">${USERS[n].role}</span>`;
        if(USERS[n].role === 'Admin') document.getElementById('adminCol').classList.remove('hidden');
        refreshHistory();
    } else { alert("Login Failed."); }
}

function startExam() {
    userAns = {};
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('examScreen').classList.remove('hidden');
    document.getElementById('infoUser').innerText = `Candidate: ${currentUser}`;
    renderQuestions();
    renderNav();
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    let diff = Math.floor((Date.now() - startTime) / 1000);
    let m = Math.floor(diff/60).toString().padStart(2,'0');
    let s = (diff%60).toString().padStart(2,'0');
    document.getElementById('timerDisplay').innerText = `${m}:${s}`;
}

function renderQuestions() {
    const box = document.getElementById('qBox');
    box.innerHTML = BANK.map((q, i) => {
        let content = "";
        if(q.type === 'essay') {
            content = `<textarea oninput="saveAns(${i}, this.value)" placeholder="Type your explanation here...">${userAns[i] || ''}</textarea>`;
        } else {
            const lbl = ['A','B','C','D'];
            content = q.o.map((o, oi) => `
                <div class="option ${userAns[i] === oi ? 'selected' : ''}" onclick="saveAns(${i}, ${oi})">
                    <strong>${lbl[oi]}.</strong> ${o}
                </div>
            `).join('');
        }
        return `
            <div class="card" id="q_${i}">
                <div style="margin-bottom:10px;">
                    <span class="badge ${q.type==='essay'?'badge-essay':'badge-mcq'}">${q.type==='essay'?'Essay':'MCQ'}</span>
                    <strong>Question ${i+1}</strong>
                </div>
                <p>${q.q}</p>
                ${content}
            </div>`;
    }).join('');
}

function saveAns(i, v) {
    userAns[i] = v;
    renderNav();
    if(BANK[i].type !== 'essay') renderQuestions();
}

function renderNav() {
    document.getElementById('navGrid').innerHTML = BANK.map((_, i) => `
        <div class="nav-btn ${userAns.hasOwnProperty(i) && userAns[i] !== "" ? 'answered' : ''}" 
             onclick="document.getElementById('q_${i}').scrollIntoView({behavior:'smooth', block:'center'})">${i+1}</div>
    `).join('');
}

function submitExam() {
    if(!confirm("Submit exam?")) return;
    clearInterval(timerInterval);
    let mcqCorrect = 0;
    BANK.filter(q => !q.type).forEach((q, i) => { if(userAns[i] === q.a) mcqCorrect++; });
    let pct = Math.round(mcqCorrect / 50 * 100);
    saveRecord(pct);
    showReview(pct, `MCQ Score: ${mcqCorrect}/50`);
}

function showReview(pct, info) {
    document.getElementById('examScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    document.getElementById('resScore').innerText = pct + "%";
    document.getElementById('resInfo').innerText = info;

    document.getElementById('reviewBox').innerHTML = BANK.map((q, i) => {
        let body = "";
        if(q.type === 'essay') {
            body = `<div style="background:#fff3e0; padding:10px; border-radius:5px; margin-bottom:10px;"><strong>Your Response:</strong><br>${userAns[i] || '<i>No answer</i>'}</div>`;
        } else {
            const lbl = ['A','B','C','D'];
            body = q.o.map((o, oi) => {
                let cls = (oi === q.a) ? 'correct-view' : (userAns[i] === oi ? 'wrong-view' : '');
                return `<div class="option ${cls}"><strong>${lbl[oi]}.</strong> ${o} ${oi === q.a ? '✓' : ''}</div>`;
            }).join('');
        }
        return `
            <div class="card">
                <p><strong>${i+1}. ${q.q}</strong></p>
                ${body}
                <div class="explanation-box">
                    <strong><i class="fas fa-lightbulb"></i> Discussion & Explanation:</strong><br>${q.e}
                </div>
            </div>`;
    }).join('');
}

// --- DATA PERSISTENCE ---

function saveRecord(s) {
    let db = JSON.parse(localStorage.getItem('krisna_pg01_final') || '[]');
    db.push({n: currentUser, s: s, d: new Date().toLocaleString()});
    localStorage.setItem('krisna_pg01_final', JSON.stringify(db));
}

function refreshHistory() {
    let db = JSON.parse(localStorage.getItem('krisna_pg01_final') || '[]');
    let html = db.reverse().map((r, i) => `
        <tr>
            <td style="padding:10px; border-bottom:1px solid #eee;">${r.n}</td>
            <td style="padding:10px; border-bottom:1px solid #eee;"><strong>${r.s}%</strong></td>
            <td style="padding:10px; border-bottom:1px solid #eee;"><small>${r.d}</small></td>
            <td class="${USERS[currentUser].role==='Admin'?'':'hidden'}" style="text-align:center; border-bottom:1px solid #eee;">
                <button onclick="delRec(${db.length-1-i})" style="background:none; color:red; width:auto; padding:0;"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`).join('');
    document.getElementById('histBody').innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding:20px;">No records.</td></tr>';
}

function delRec(i) {
    let db = JSON.parse(localStorage.getItem('krisna_pg01_final') || '[]');
    db.splice(i, 1);
    localStorage.setItem('krisna_pg01_final', JSON.stringify(db));
    refreshHistory();
}

function exitExam() { if(confirm("Discard exam?")) location.reload(); }

</script>
</body>
</html>
