<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Krisna Exam System - FINAL EXAM PG01 (MCQ + ESSAY)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #2d3436;
  --muted: #636e72;
  --teal: #008080;
  --teal-light: #e0f2f2;
  --correct: #27ae60;
  --wrong: #d63031;
  --border: #dfe6e9;
  --admin-color: #6c5ce7;
  --info-bg: #e1f5fe;
  --essay-bg: #fff3e0;
}

* { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
body { margin: 0; background: var(--bg); color: var(--text); line-height: 1.6; }

header { background: var(--card); border-bottom: 3px solid var(--teal); box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 10px 20px; position: sticky; top: 0; z-index: 1000; }
.header-inner { max-width: 1200px; margin: auto; display: flex; justify-content: space-between; align-items: center; }
h1 { margin: 0; color: var(--teal); font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }

.container { max-width: 1200px; margin: 20px auto; padding: 0 15px; }
.card { background: var(--card); border-radius: 8px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid var(--border); }

/* Badges */
.badge-essay { background: #f39c12; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
.badge-mcq { background: var(--teal); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }

.exam-grid { display: grid; grid-template-columns: 260px 1fr 260px; gap: 20px; align-items: start; }
.sidebar-left, .sidebar-right { position: sticky; top: 80px; background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
.sidebar-left { border-left: 4px solid var(--teal); }
.sidebar-right { border-right: 4px solid var(--teal); }

.timer-box { font-size: 1.8rem; font-weight: bold; text-align: center; margin: 15px 0; padding: 10px; background: var(--bg); border-radius: 5px; border: 1px solid var(--border); }

.nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; padding: 5px; }
.nav-btn { padding: 8px 0; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.75rem; }
.nav-btn.answered { background: var(--teal); color: white; border-color: var(--teal); }

.option { display: block; border: 1px solid var(--border); padding: 12px 15px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; position: relative; }
.option.selected { border-color: var(--teal); background: var(--teal-light); font-weight: 600; }
.correct-view { background: #d4edda !important; border-color: #c3e6cb !important; color: #155724; }
.wrong-view { background: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; }

.explanation-box { background: var(--info-bg); padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #0288d1; font-size: 0.9rem; }
.model-answer-box { background: #e8f5e9; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #2e7d32; font-size: 0.9rem; }
.user-essay-box { background: var(--essay-bg); padding: 15px; border-radius: 6px; margin-top: 10px; border: 1px dashed #f39c12; font-style: italic; }

button { background: var(--teal); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
button:hover { opacity: 0.9; transform: translateY(-1px); }
button.secondary { background: var(--muted); }
button.danger { background: var(--wrong); }
button.admin-btn { background: var(--admin-color); width: auto; font-size: 0.8rem; padding: 5px 10px; margin-left: 5px; }

textarea { width: 100%; height: 120px; padding: 12px; border-radius: 6px; border: 1px solid var(--border); font-size: 1rem; resize: vertical; margin-top: 10px; }
textarea:focus { outline: none; border-color: var(--teal); box-shadow: 0 0 5px rgba(0,128,128,0.2); }

input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
.hidden { display: none !important; }

@media (max-width: 900px) {
    .exam-grid { display: block; }
    .sidebar-left, .sidebar-right { position: relative; top: 0; width: 100%; margin-bottom: 20px; }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex; align-items:center; gap:10px;">
        <i class="fas fa-globe-asia" style="color:var(--teal); font-size:1.5rem;"></i>
        <h1>Krisna Exam System <small style="font-size:0.6rem; opacity:0.7;">PG01 COMPREHENSIVE</small></h1>
    </div>
    <div id="userDisplay" style="font-weight:bold; color:var(--muted);"></div>
  </div>
</header>

<div class="container">
  <div id="startScreen" class="card" style="max-width:400px; margin: 60px auto; text-align:center;">
    <h2 style="color:var(--teal)">Secure Access</h2>
    <p style="font-size:0.8rem; color:var(--muted);">PG01 GEODESY FINAL</p>
    <input type="text" id="candidateName" placeholder="Username">
    <input type="password" id="candidatePass" placeholder="Password">
    <button onclick="login()">ENTER SYSTEM <i class="fas fa-sign-in-alt"></i></button>
  </div>

  <div id="menuScreen" class="hidden">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">EXAMINATION DASHBOARD</h3>
            <button class="secondary" style="width:auto;" onclick="location.reload()">Logout</button>
        </div>
        <div id="roleBadge" style="display:inline-block; padding:5px 15px; border-radius:20px; font-size:0.8rem; font-weight:bold; margin-bottom:20px;"></div>
        
        <button id="mainModuleBtn" onclick="handleModuleClick()" style="background:#e0f2f2; color:var(--teal); border:2px solid var(--teal); padding:30px; font-size:1.1rem; text-align:left;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span><i class="fas fa-graduation-cap"></i> Start Final Exam (50 MCQ + 25 Essay)</span>
                <i class="fas fa-chevron-right"></i>
            </div>
        </button>
    </div>
    
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">Performance History</h3>
            <div id="adminTools" class="hidden">
                <button class="admin-btn" onclick="exportCSV()"><i class="fas fa-download"></i> CSV</button>
                <button class="admin-btn danger" onclick="clearAllData()"><i class="fas fa-trash-alt"></i> Clear All</button>
            </div>
        </div>
        <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
                <thead><tr style="background:#f8f9fa;">
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Candidate</th>
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Score</th>
                    <th style="padding:10px; border-bottom:1px solid #ddd; text-align:left;">Date</th>
                    <th id="adminCol" class="hidden" style="padding:10px; border-bottom:1px solid #ddd; text-align:center;">Action</th>
                </tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="examScreen" class="exam-grid hidden">
    <aside class="sidebar-left">
        <h3>Details</h3>
        <p id="displayUser" style="font-size:0.8rem; color:var(--muted);"></p>
        <div class="timer-box" id="timerDisplay">00:00</div>
        <button onclick="exitExam()" class="secondary">Cancel</button>
    </aside>

    <section id="qBox"></section>

    <aside class="sidebar-right">
        <h4>Navigation</h4>
        <div id="navGrid" class="nav-grid"></div>
        <button onclick="submitExam()" style="padding:15px; background:var(--correct);">SUBMIT ALL <i class="fas fa-check-circle"></i></button>
    </aside>
  </div>

  <div id="resultScreen" class="hidden card">
    <div style="text-align:center; padding:20px;">
        <h2>Assessment Summary</h2>
        <div id="resScore" style="font-size:4rem; color:var(--teal); font-weight:800;">0%</div>
        <p id="resInfo" style="color:var(--muted);"></p>
        <button onclick="location.reload()" style="width:auto; padding:10px 30px;">Finish Review</button>
    </div>
    <hr>
    <h3 style="padding:10px;">Review & Master Key</h3>
    <div id="reviewBox"></div>
  </div>
</div>

<script>
const USERS = {
    "Sena": { pass: "Sena!32", role: "Student" },
    "Krisna": { pass: "Krisna!32", role: "Admin" },
    "Flint": { pass: "Flint!32", role: "Student" }
};

const BANK = [
    // --- 50 MCQs (Disingkat untuk efisiensi ruang, tetap 50 soal) ---
    { q: "In linear algebra, what is the result of the dot product of two orthogonal vectors?", o: ["1", "-1", "0", "Infinity"], a: 2, e: "Dua vektor ortogonal memiliki dot product nol." },
    { q: "Which matrix property must be satisfied for Ax = B to have a unique solution?", o: ["Det = 0", "Det != 0", "A is row vector", "A is singular"], a: 1, e: "Determinan tidak boleh nol agar matriks memiliki invers." },
    { q: "In 2D coordinate transformation, which functions are used in the rotation matrix?", o: ["Sine and Cosine", "Tan and Cotan", "Sec and Cosec", "Only Sine"], a: 0, e: "Rotasi menggunakan sin dan cos." },
    { q: "The 'Taylor Series' is used in geodesy primarily for:", o: ["Distance", "Linearization", "Weight", "Shape"], a: 1, e: "Taylor Series melinearisasi persamaan non-linier." },
    { q: "A 'Great Circle' on a sphere represents:", o: ["Constant bearing", "Small circle", "Shortest distance", "Rhumb line"], a: 2, e: "Great circle adalah jalur terpendek (geodesic)." },
    { q: "What happens to the sum of angles in a spherical triangle?", o: ["= 180°", "> 180°", "< 180°", "Variable"], a: 1, e: "Jumlah sudut segitiga bola selalu > 180°." },
    { q: "In statistics, the 'Standard Deviation' is a measure of:", o: ["Accuracy", "Precision", "Bias", "Systematic"], a: 1, e: "Mengukur sebaran (presisi)." },
    { q: "Percentage of data within ±1 sigma in Normal Distribution?", o: ["50%", "68%", "95%", "99%"], a: 1, e: "68.3% berada di dalam 1 sigma." },
    { q: "Principle of 'Least Squares' minimizes:", o: ["Sum of residuals", "Sum of squares of residuals", "Max error", "Average"], a: 1, e: "Meminimalkan jumlah kuadrat sisaan." },
    { q: "Measurement with high variance will have:", o: ["High weight", "Low weight", "No weight", "Same weight"], a: 1, e: "Bobot = 1/variansi." },
    { q: "Interpolation using piecewise polynomials:", o: ["Linear", "Nearest", "Cubic Splines", "IDW"], a: 2, e: "Splines membuat kurva halus." },
    { q: "The 'Geoid' is best defined as:", o: ["Ellipsoid", "Equipotential surface", "Land surface", "Mountain height"], a: 1, e: "Permukaan gravitasi konstan." },
    { q: "Reference for 'Orthometric Heights'?", o: ["Ellipsoid", "Geoid", "Terrain", "Topography"], a: 1, e: "Tinggi ortometrik diukur dari geoid." },
    { q: "A 'Loxodrome' crosses meridians at:", o: ["Same angle", "Shortest path", "Straight line", "Connects poles"], a: 0, e: "Sudut konstan (Rhumb line)." },
    { q: "System that rotates with the Earth:", o: ["CIS", "CTS", "Celestial", "Local"], a: 1, e: "CTS (Conventional Terrestrial System)." },
    { q: "Shape defined by a and f:", o: ["Sphere", "Oblate Spheroid", "Geoid", "Prolate"], a: 1, e: "Ellipsoid pepat." },
    { q: "Map Projection always has distortion EXCEPT:", o: ["Shape", "Area", "Distance", "None"], a: 3, e: "Semua proyeksi pasti ada distorsi." },
    { q: "Mercator is used in navigation because:", o: ["Equal-area", "Conformal", "Equidistant", "Gnomonic"], a: 1, e: "Mempertahankan sudut (konformal)." },
    { q: "Number of UTM zones?", o: ["30", "60", "90", "180"], a: 1, e: "60 zona (6 derajat)." },
    { q: "GNSS segment for maintaining orbits?", o: ["Space", "Control", "User", "Satellite"], a: 1, e: "Control segment." },
    { q: "Pseudorange is based on:", o: ["Phase", "Time travel of code", "Doppler", "Pressure"], a: 1, e: "Waktu tempuh sinyal kode." },
    { q: "RTK stands for:", o: ["Kinetography", "Real-Time Kinematic", "Relative", "Remote"], a: 1, e: "Real-Time Kinematic." },
    { q: "Better geometry is indicated by DOP:", o: ["1.2", "5.0", "10.0", "20.0"], a: 0, e: "Semakin kecil DOP semakin baik." },
    { q: "In hydrography, 'Heave' is:", o: ["Vertical motion", "Roll", "Pitch", "Drift"], a: 0, e: "Gerak naik-turun kapal." },
    { q: "Tool for acceleration and angular velocity:", o: ["GNSS", "Echo", "IMU", "Magnetometer"], a: 2, e: "IMU (Inertial Measurement Unit)." },
    { q: "Height measured directly by GNSS?", o: ["H", "h", "N", "Dynamic"], a: 1, e: "Tinggi ellipsoidal (h)." },
    { q: "Collimation error in levelling:", o: ["Line of sight not horizontal", "Staff not vertical", "Curvature", "Sun"], a: 0, e: "Teropong tidak mendatar." },
    { q: "Standard vertical datum for soundings:", o: ["MSL", "HAT", "Chart Datum", "Ellipsoid"], a: 2, e: "Chart Datum (LAT)." },
    { q: "'Dead Reckoning' is in:", o: ["GNSS", "INS", "Tide", "Map"], a: 1, e: "Inertial Navigation." },
    { q: "Cause of 'Drift' in INS:", o: ["Blockage", "Accumulated sensor errors", "Temp", "Battery"], a: 1, e: "Integrasi error sensor." },
    { q: "Origin of WGS84?", o: ["Greenwich", "Pole", "Earth Center of Mass", "Equator"], a: 2, e: "Geosentris." },
    { q: "Jacobian Matrix is for:", o: ["Mean", "Propagation of uncertainty", "Observations", "Contours"], a: 1, e: "Turunan parsial untuk rambat kesalahan." },
    { q: "Error removed by procedure:", o: ["Random", "Systematic", "Blunder", "None"], a: 1, e: "Sistematik." },
    { q: "Centimeter accuracy in real-time:", o: ["DGPS", "Standalone", "RTK", "LORAN"], a: 2, e: "RTK." },
    { q: "Ellipsoid - Geoid distance:", o: ["Deflection", "Geoid Undulation (N)", "Correction", "Sigma"], a: 1, e: "N = h - H." },
    { q: "A x B = B x A?", o: ["Yes", "No", "Identity", "1x1"], a: 1, e: "Tidak komutatif." },
    { q: "Moving the origin only:", o: ["Translation", "Rotation", "Scaling", "Reflection"], a: 0, e: "Translasi." },
    { q: "Bilinear interpolation estimates within:", o: ["Line", "Grid cell", "Triangle", "Time"], a: 1, e: "Grid persegi." },
    { q: "Multipath in GNSS:", o: ["Constellations", "Reflected signals", "Software", "Jamming"], a: 1, e: "Sinyal memantul." },
    { q: "Total Station measures:", o: ["Angles", "Distances", "Both", "Gravity"], a: 2, e: "Sudut dan Jarak." },
    { q: "Accelerometers in 6-DOF IMU?", o: ["1", "2", "3", "6"], a: 2, e: "3 (X, Y, Z)." },
    { q: "IHO Order 1a is for:", o: ["Critical clearance", "Deep", "General", "No ships"], a: 0, e: "Area dangkal berbahaya." },
    { q: "Inverse of Matrix A:", o: ["Transpose", "Produces Identity", "Square", "Zero"], a: 1, e: "A * A' = I." },
    { q: "Random Error example:", o: ["Calib tape", "Curvature", "Wind on staff", "Typo"], a: 2, e: "Fluktuasi angin." },
    { q: "Bilinear uses how many points?", o: ["2", "3", "4", "8"], a: 2, e: "4 titik grid." },
    { q: "Atmospheric Refraction effect:", o: ["Shorter", "Bends line of sight", "Color", "None"], a: 1, e: "Pembiasan cahaya." },
    { q: "Histogram of survey errors:", o: ["Linear", "Bell-shaped", "Square", "Random"], a: 1, e: "Distribusi Normal." },
    { q: "Trigonometric Levelling uses:", o: ["Pressure", "Angles and distances", "GNSS", "Level"], a: 1, e: "Hitung tinggi via sudut." },
    { q: "Phase Center Offset (PCO) for:", o: ["GNSS Antenna", "Transducer", "Laser", "Compass"], a: 0, e: "Pusat elektronik antena." },
    { q: "Kalman Filter integration:", o: ["Hull", "Weather", "GNSS and INS", "Tide"], a: 2, e: "Optimal sensor fusion." },

    // --- 25 ESSAYS (Ditambahkan Sesuai Permintaan) ---
    { q: "Explain the difference between Accuracy and Precision.", type: "essay", e: "Precision means all your measurements are very close to each other (consistent). Accuracy means your measurements are very close to the true value (correct). You can be precise but not accurate if you have a systematic error." },
    { q: "What is a Geoid and why is it important for surveyors?", type: "essay", e: "The Geoid is the shape of the Earth based on gravity. It is like the level of the ocean if it covered the whole world. It is important because we use it to measure heights above sea level (Orthometric height)." },
    { q: "Describe the purpose of a Map Projection.", type: "essay", e: "The Earth is round like a ball, but a map is flat. A map projection is a way to put the round Earth onto a flat paper. This always causes some changes (distortions) in size, shape, or distance." },
    { q: "Why do we use the Least Squares method in surveying?", type: "essay", e: "We often have more measurements than we need (redundancy). The Least Squares method helps us find the best single answer by making the total error as small as possible." },
    { q: "What is the main difference between WGS84 and a local datum?", type: "essay", e: "WGS84 is a global system for the whole world and uses the center of the Earth as its start point. A local datum is made to fit only one specific area or country very well." },
    { q: "Explain how GNSS RTK works in simple terms.", type: "essay", e: "RTK uses two receivers. One is at a known 'Base' and one is moving (Rover). The Base sends corrections to the Rover using a radio. This helps the Rover get cm-level accuracy very fast." },
    { q: "What is 'Heave' and how does it affect bathymetry?", type: "essay", e: "Heave is the up and down movement of a ship because of waves. If we don't fix it, the sea floor will look wavy in our data. We use a motion sensor to remove this movement." },
    { q: "What are the three segments of GPS?", type: "essay", e: "1. Space Segment (the satellites), 2. Control Segment (ground stations), and 3. User Segment (our receivers like phones or survey tools)." },
    { q: "What is a 'Rhumb Line'?", type: "essay", e: "A Rhumb Line is a path that has a constant compass direction. It is easy for sailors to follow, but it is not the shortest path between two points." },
    { q: "Explain the term 'Ellipsoidal Height'.", type: "essay", e: "It is the height measured from a mathematical ellipsoid surface. GNSS gives us this height (h). It is different from the height above sea level (H)." },
    { q: "What is 'Multipath' error in GPS?", type: "essay", e: "It happens when the GPS signal hits a building or a ship's crane before it reaches the antenna. This makes the signal arrive late and causes a position error." },
    { q: "Why is 'Sound Velocity' important in hydrographic surveys?", type: "essay", e: "Echo sounders measure time to calculate depth. If we don't know the correct speed of sound in water, the depth calculation will be wrong." },
    { q: "Describe 'Differential Levelling'.", type: "essay", e: "It is a way to find the height difference between two points. We use a level instrument and a graduated staff. We subtract the foresight from the backsight." },
    { q: "What is the 'Jacobian Matrix' used for?", type: "essay", e: "It is a matrix of partial derivatives. We use it to linearize non-linear observation equations and for the propagation of uncertainties in Least Squares." },
    { q: "What is the UTM coordinate system?", type: "essay", e: "UTM is a global grid system that divides the Earth into 60 zones. It uses a Transverse Mercator projection to provide high accuracy for mapping in each zone." },
    { q: "Explain the role of an IMU in INS.", type: "essay", e: "An IMU (Inertial Measurement Unit) uses accelerometers and gyroscopes to measure movement and rotation. It allows the system to calculate position using dead reckoning." },
    { q: "What is 'Spherical Excess'?", type: "essay", e: "It is the amount by which the sum of the angles of a spherical triangle exceeds 180 degrees. This is caused by the Earth's curvature." },
    { q: "What is a 'Blunder' in surveying?", type: "essay", e: "A blunder is a gross error caused by human mistake, like misreading a staff or typing the wrong number. It must be removed before processing." },
    { q: "How does the Normal Distribution relate to survey errors?", type: "essay", e: "It assumes that small random errors happen more often than large ones, and positive/negative errors are equally likely, forming a bell curve." },
    { q: "What is a 'Reference Ellipsoid'?", type: "essay", e: "It is a mathematical model of the Earth's shape (an oblate spheroid) used as a smooth surface for calculating geographic coordinates (Lat, Lon)." },
    { q: "Why is Tide Correction necessary?", type: "essay", e: "Because the water level changes with the tide. To make a consistent map, we must reduce all soundings to a fixed level called Chart Datum." },
    { q: "Define sensor 'Calibration'.", type: "essay", e: "Calibration is the process of checking and adjusting an instrument against a standard to ensure its measurements are accurate and free of systematic bias." },
    { q: "What is the 'Semi-major axis' (a)?", type: "essay", e: "The semi-major axis is the longest radius of the reference ellipsoid, representing the distance from the Earth's center to the Equator." },
    { q: "What is 'Interpolation'?", type: "essay", e: "Interpolation is a mathematical method to estimate unknown values at specific locations based on the known values of surrounding data points." },
    { q: "What is 'DOP' and how does it affect GNSS?", type: "essay", e: "DOP (Dilution of Precision) describes the geometry of the satellites. Low DOP means satellites are well-spread, resulting in better positioning accuracy." }
];

let currentUser = "";
let currentRole = "";
let userAns = {};
let isAdmin = false;
let timerInterval;
let startTime;

function login() {
    let name = document.getElementById('candidateName').value.trim();
    let pass = document.getElementById('candidatePass').value.trim();
    if(USERS[name] && USERS[name].pass === pass) {
        currentUser = name;
        currentRole = USERS[name].role;
        isAdmin = (currentRole === "Admin");
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('menuScreen').classList.remove('hidden');
        const badge = document.getElementById('roleBadge');
        badge.innerText = currentRole.toUpperCase();
        badge.style.background = isAdmin ? "var(--admin-color)" : "var(--teal)";
        badge.style.color = "white";
        document.getElementById('userDisplay').innerHTML = `Candidate: <strong>${currentUser}</strong>`;
        if(isAdmin) {
            document.getElementById('adminTools').classList.remove('hidden');
            document.getElementById('adminCol').classList.remove('hidden');
        }
        refreshHistory();
    } else { alert("Access Denied."); }
}

function handleModuleClick() {
    if(isAdmin) {
        if(confirm("Admin Mode: View MASTER KEY?")) showMasterKey();
        else startExam();
    } else startExam();
}

function startExam() {
    userAns = {};
    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('examScreen').classList.remove('hidden');
    renderQuestions();
    renderNav();
    startTime = Date.now();
    timerInterval = setInterval(() => {
        let diff = Math.floor((Date.now() - startTime) / 1000);
        let m = Math.floor(diff/60).toString().padStart(2,'0');
        let s = (diff%60).toString().padStart(2,'0');
        document.getElementById('timerDisplay').innerText = `${m}:${s}`;
    }, 1000);
}

function renderQuestions() {
    const box = document.getElementById('qBox');
    box.innerHTML = BANK.map((q, i) => {
        let inputArea = "";
        const badge = q.type === 'essay' ? '<span class="badge-essay">ESSAY</span>' : '<span class="badge-mcq">MCQ</span>';
        
        if(q.type === 'essay') {
            inputArea = `<textarea placeholder="Type your answer..." oninput="saveEssay(${i}, this.value)">${userAns[i] || ""}</textarea>`;
        } else {
            const lbl = ['A', 'B', 'C', 'D'];
            inputArea = q.o.map((text, oi) => `
                <div class="option ${userAns[i] === oi ? 'selected' : ''}" onclick="saveMCQ(${i}, ${oi})">
                    <strong>${lbl[oi]}.</strong> ${text}
                </div>
            `).join('');
        }

        return `
            <div class="card" id="q_${i}">
                <p><strong>Question ${i+1}</strong> ${badge}</p>
                <p>${q.q}</p>
                ${inputArea}
            </div>
        `;
    }).join('');
}

function saveMCQ(idx, val) {
    userAns[idx] = val;
    renderNav();
    renderQuestions();
}

function saveEssay(idx, text) {
    userAns[idx] = text;
    renderNav();
}

function renderNav() {
    document.getElementById('navGrid').innerHTML = BANK.map((_, i) => {
        const isAnswered = userAns.hasOwnProperty(i) && (typeof userAns[i] === 'number' || userAns[i].trim().length > 0);
        return `<div class="nav-btn ${isAnswered ? 'answered' : ''}" onclick="document.getElementById('q_${i}').scrollIntoView({behavior:'smooth', block:'center'})">${i+1}</div>`;
    }).join('');
}

function submitExam() {
    if(!confirm("Submit results?")) return;
    clearInterval(timerInterval);
    
    let mcqScore = 0;
    let essayAttempted = 0;
    
    BANK.forEach((q, i) => {
        if(q.type === 'essay') {
            if(userAns[i] && userAns[i].trim().length > 10) essayAttempted++;
        } else {
            if(userAns[i] === q.a) mcqScore++;
        }
    });

    const totalPossible = BANK.length;
    const finalScore = Math.round(((mcqScore + essayAttempted) / totalPossible) * 100);
    
    saveRecord(finalScore);
    showResult(finalScore, `MCQ: ${mcqScore}/50 | Essay Attempted: ${essayAttempted}/25`);
}

function showResult(pct, info) {
    document.getElementById('examScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    document.getElementById('resScore').innerText = (pct === "KEY" ? "KEY" : pct + "%");
    document.getElementById('resInfo').innerText = info;
    
    const lbl = ['A', 'B', 'C', 'D'];
    document.getElementById('reviewBox').innerHTML = BANK.map((q, i) => {
        if(q.type === 'essay') {
            return `
                <div class="card">
                    <p><strong>${i+1}. ${q.q}</strong> <span class="badge-essay">ESSAY</span></p>
                    <div class="user-essay-box"><strong>Your Answer:</strong><br>${userAns[i] || "(No answer)"}</div>
                    <div class="model-answer-box"><strong>Model Answer:</strong><br>${q.e}</div>
                </div>
            `;
        } else {
            let opts = q.o.map((text, oi) => {
                let cls = (oi === q.a) ? 'correct-view' : (userAns[i] === oi ? 'wrong-view' : '');
                return `<div class="option ${cls}"><strong>${lbl[oi]}.</strong> ${text} ${oi === q.a ? '✓' : ''}</div>`;
            }).join('');
            return `
                <div class="card">
                    <p><strong>${i+1}. ${q.q}</strong> <span class="badge-mcq">MCQ</span></p>
                    ${opts}
                    <div class="explanation-box"><strong>Explanation:</strong><br>${q.e}</div>
                </div>
            `;
        }
    }).join('');
}

function showMasterKey() {
    userAns = {};
    showResult("KEY", "Displaying Master Key for PG01");
}

function saveRecord(s) {
    let data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    data.push({n: currentUser, s: s, d: new Date().toLocaleString()});
    localStorage.setItem('krisna_pg01_db', JSON.stringify(data));
}

function refreshHistory() {
    let data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    document.getElementById('histBody').innerHTML = data.reverse().map((h, i) => `
        <tr>
            <td style="padding:10px; border-bottom:1px solid #eee;">${h.n}</td>
            <td style="padding:10px; border-bottom:1px solid #eee;"><strong>${h.s}%</strong></td>
            <td style="padding:10px; border-bottom:1px solid #eee;"><small>${h.d}</small></td>
            <td class="${isAdmin?'':'hidden'}" style="text-align:center; border-bottom:1px solid #eee;">
                <button onclick="deleteSingle(${data.length-1-i})" style="background:none; color:red; width:auto; padding:0;"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('') || '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">No history.</td></tr>';
}

function deleteSingle(i) {
    let data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    data.splice(i, 1);
    localStorage.setItem('krisna_pg01_db', JSON.stringify(data));
    refreshHistory();
}

function clearAllData() { if(confirm("Wipe all?")) { localStorage.removeItem('krisna_pg01_db'); refreshHistory(); } }
function exportCSV() {
    let data = JSON.parse(localStorage.getItem('krisna_pg01_db') || '[]');
    let csv = "Candidate,Score,Date\n" + data.map(h => `"${h.n}",${h.s},"${h.d}"`).join('\n');
    let a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = 'PG01_Results.csv';
    a.click();
}
function exitExam() { if(confirm("Cancel?")) location.reload(); }
</script>
</body>
</html>
